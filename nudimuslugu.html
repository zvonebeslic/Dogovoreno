<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moj profil — Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
  <style>
    :root{
      --bg:#0f1115; --ink:#0b1220; --muted:#334155;
      --cta:#2563eb; --accent:#16a34a;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    body{ background:#0f1115; color:#f7f8fa; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    .page{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto; }
    .page-wrap{ max-width:980px; margin:18px auto 64px; padding:0 16px; }

    /* Cloud – svijetla kartica kao na trazimuslugu.html */
    .cloud{
      background: linear-gradient(180deg, rgba(255,255,255,.78) 0%, rgba(246,247,249,.72) 100%);
      backdrop-filter: blur(4px);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), 0 8px 22px rgba(0,0,0,.22);
      padding:16px; margin:12px 0; color:var(--ink);
    }
    .cloud h3,.cloud h4{ margin:0 0 10px; font-size:18px; color:#0b1220 }
    .lead, .muted{ color:#c7cbd4 }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px }
    .row{ display:grid; gap:10px }
    .row.two{ grid-template-columns:1fr 1fr }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }

    /* Chip identičan tražimuslugu */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.6);
      font-weight:600; color:#0b1220;
    }
    .chip button{ all:unset; cursor:pointer; opacity:.85 }
    .chip button:hover{ opacity:1 }

    /* Bijeli inputi/textarea/select (crni tekst) – isto kao na trazimuslugu */
    .cloud input[type="text"],
    .cloud input[type="url"],
    .cloud input[type="search"],
    .cloud select,
    .cloud textarea{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff; color:#0b1220;
      outline:none; font-family:inherit;
    }
    .cloud textarea{ min-height:140px; resize:vertical }
    .cloud input:focus,
    .cloud select:focus,
    .cloud textarea:focus{
      outline:2px solid rgba(37,99,235,.25);
      border-color:rgba(37,99,235,.45);
    }
    .cloud input::placeholder,
    .cloud textarea::placeholder{ color:#64748b; }

    /* Gumbi – kao na trazimuslugu */
    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer }
    .btn-primary{
      background:linear-gradient(180deg, #2b6ee9 0%, #245ed0 100%);
      color:#fff; border:1px solid rgba(0,0,0,.2);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.15), 0 6px 16px rgba(37,99,235,.28);
      transition: transform .08s ease;
    }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-ghost{ background:transparent; color:#ffffff; border:2px solid #ffffff; }
    .btn-accent{
      background: linear-gradient(180deg, #16a34a 0%, #0f8a3a 55%, #0b6f30 100%);
      color:#e6fff4; border:1px solid rgba(0,0,0,.35);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 6px 16px rgba(16,163,74,.25);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn-accent:hover{ filter:brightness(1.03); box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 8px 20px rgba(16,163,74,.32); }
    .btn-accent:active{ transform: translateY(1px); box-shadow: inset 0 2px 4px rgba(0,0,0,.25), 0 3px 10px rgba(16,163,74,.22); }
    .btn-small{ padding:8px 10px; border-radius:10px }

    /* Linklike kao na trazimuslugu */
    .linklike{ color:#1f3b7c; text-decoration:underline; cursor:pointer }

    /* Dialog – tamni kao na trazimuslugu */
    dialog{ border:0; border-radius:16px; background:#0e1014; color:#f7f8fa; width:min(720px, 96vw) }
    dialog::backdrop{ background:rgba(0,0,0,.4) }
    .dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    .dlg-body{ padding:0; max-height:70vh; overflow:auto; overscroll-behavior:contain; }
    .dlg-actions{ padding:14px 16px; display:flex; gap:10px; justify-content:center; border-top:1px solid rgba(255,255,255,.08) }
    .dlg-search{ position:sticky; top:0; z-index:2; background:#0e1014; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    #skillSearch{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b0d11; color:#fff }

    /* Lista stavki u popupu (isti vizual) */
    .list{ display:grid; gap:8px; padding:14px 16px; min-height:35vh; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03); }
    .item input{ transform:scale(1.2) }

    /* DlgPlace – svijetli kao na trazimuslugu */
    #dlgPlace{
      background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(246,247,249,.86) 100%);
      color:#0b1220;
    }
    #dlgPlace .dlg-head{ border-bottom:1px solid rgba(0,0,0,.08); }
    #dlgPlace .dlg-actions{ border-top:1px solid rgba(0,0,0,.08); }
    #dlgPlace .field select,
    #dlgPlace .field input[type="text"],
    #dlgPlace .field input[type="url"],
    #dlgPlace .field input[type="search"]{
      background:#ffffff; color:#0b1220;
      border:1px solid rgba(0,0,0,.15);
      border-radius:12px; padding:10px 12px; outline:none;
      font-family:inherit; font-size:inherit;
    }
    #dlgPlace .field select:focus,
    #dlgPlace .field input:focus{
      outline:2px solid rgba(37,99,235,.25);
      border-color:rgba(37,99,235,.45);
    }
    #dlgPlace .help, #dlgPlace .note{ color:#0b1220; }
    #dlgPlace .btn-ghost{
      background:transparent; color:#0b1220; border:1px solid rgba(0,0,0,.20);
    }
    #dlgPlace .btn-ghost:hover{ background:rgba(0,0,0,.05); }

    /* Upload – identičan */
    .uploader-minimal{ margin:8px 0 0; }
    .upload-link{ appearance:none; background:transparent; border:0; text-decoration:underline; cursor:pointer; padding:4px 0; font-weight:600; color:#f7f8fa; }
    .cloud .upload-link{ color:#0b1220; }
    .upload-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:10px; margin-top:8px; }
    .thumb{ position:relative; border-radius:10px; overflow:hidden; background:#0b0d11; border:1px solid rgba(255,255,255,.12); }
    .cloud .thumb{ background:#ffffff; border:1px solid rgba(0,0,0,.12); }
    .thumb img{ width:100%; height:72px; object-fit:cover; display:block }
    .thumb button{ position:absolute; top:6px; right:6px; border:0; border-radius:8px; padding:4px 6px; background:rgba(0,0,0,.5); color:#fff; cursor:pointer; }

    /* Akcije kao na tražimuslugu (desno) */
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }

    /* CENTRIRAJ “Recenzije” */
    .cloud.center{ display:flex; justify-content:center; }
    .cloud.center .chip{ margin:0 auto; }

    /* TOAST – isti kao na Tražim uslugu */
    .toast{
      position:fixed;
      left:50%;
      bottom:25px;
      transform:translateX(-50%);
      background:#f97316;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:var(--shadow);
      display:none;
      z-index:9999;
    }
    .toast.show{ display:block }

    /* ================== POPUP ZA SATE ================== */
    /* Pop-up kontejner: fiksne dimenzije, ne širi stranicu */
    #hourPopover{
      position:absolute;
      z-index: 9999;
      background: rgba(15,17,21,.98);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      width: 150px;
      max-height: 40vh;      /* pop-up visina */
      overflow: hidden;      /* što izađe, ne vidi se */
    }
    /* Jedan stupac, scroll unutar pop-upa */
    .hour-grid{
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 35vh;      /* lista scrola unutra */
      overflow-y: auto;
      padding-right: 4px;    /* da scrollbar ne preklapa tekst */
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    .hour-btn{
      appearance: none;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.06);
      color: #f7f8fa;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 16px;
      text-align: left;
      cursor: pointer;
      width: 100%;           /* puna širina za lakši tap */
    }
    .hour-btn:hover{ background: rgba(255,255,255,.12) }
    .hour-btn[aria-current="true"]{
      outline: 2px solid #16a34a;
      outline-offset: 0;
    }

    /* Disable vizual kad je “Nije potrebno” */
    #quietSection.is-disabled{ opacity:.55; pointer-events:none }
  </style>
</head>
<body>
  <main class="page">
    <div data-include="header.html"></div>

    <div class="page-wrap">
      <div class="card" style="padding:16px">
        <h2 style="font-weight:600; font-size:clamp(18px,3vw,26px); color:#f7f8fa; margin:0">Moj profil</h2>
        <div class="muted" style="color:#c7cbd4; font-size:clamp(13px,2.5vw,16px); margin-bottom:8px">(profil za one koji nude usluge)</div>

        <!-- Ime / obrt / firma -->
        <section class="cloud" aria-labelledby="lab-name">
          <h4 id="lab-name">Ime / Obrt / Firma *</h4>
          <input id="name" type="text" required placeholder="npr. Marko Marković / Obrt MarkoGradnja / XYZ d.o.o.">
          <div class="hint">* Unesite svoje ime, ili ime obrta, ili ime firme.</div>
        </section>

        <!-- Telefon -->
        <section class="cloud" aria-labelledby="lab-phone">
          <h4 id="lab-phone">Broj mob/tel *</h4>
          <input id="phone" type="text" required placeholder="+387 6X XXX XXX / +385 9X XXX XXXX">
          <div class="hint">* Napišite predbroj.</div>
        </section>

        <!-- E-mail (kontaktni) -->
        <section class="cloud" aria-labelledby="lab-email">
          <h4 id="lab-email">E-mail</h4>
          <input id="email" type="text" required placeholder="email@primjer.com" disabled>
          <div class="hint">* E-mail koristimo za obavijesti. Promijeniti ga možete u postavkama računa.</div>
        </section>

        <!-- Zanimanja – identičan UX kao na Tražim uslugu -->
        <section class="cloud" aria-labelledby="lab-skill">
          <h4 id="lab-skill">Što ste po zanimanju?</h4>
          <div class="row">
            <div id="skillsChips" class="chips" aria-live="polite"></div>
            <div style="display:flex;align-items:center;gap:8px">
              <button id="btnPickSkills" type="button" class="btn btn-accent btn-small">Odaberi zanimanja</button>
            </div>
            <div class="hint">* Odaberite zanimanje iz popisa. Max. 3 zanimanja po profilu.</div>
          </div>
        </section>

        <!-- Lokacija (privatno za match) -->
        <section class="cloud" aria-labelledby="lab-loc">
          <h4 id="lab-loc">Gdje želite da vas se pronađe? (privatno)</h4>
          <div class="row">
            <label class="help">Zalijepite link s Google karata (preporučeno)</label>
            <input id="mapsUrl" type="url" placeholder="https://maps.google.com/…">
            <div class="help">
              <span class="linklike" id="openMaps">Otvori Google karte</span>
              ·
              <span class="linklike" id="btnManualPlace" role="button" tabindex="0">Ručni odabir mjesta</span>
            </div>
          </div>
          <div class="hint" style="margin-top:8px">
            * Vaša će lokacija ovdje ostati <b>uvijek tajna</b> i nitko je neće vidjeti. Koristimo je samo za precizan match s klijentima.
          </div>
          <input type="hidden" id="lat"><input type="hidden" id="lng"><input type="hidden" id="placeLabel">
        </section>

        <!-- Područje djelovanja (JAVNO) -->
        <section class="cloud" aria-labelledby="lab-public">
          <h4 id="lab-public">Područje djelovanja (javna informacija na profilu)</h4>
          <div class="row two">
            <label>Država
              <select id="svcCountry">
                <option value="">— odaberite —</option>
              </select>
            </label>
            <label>Grad / mjesto
              <select id="svcCity" disabled>
                <option value="">— prvo odaberite državu —</option>
              </select>
            </label>
          </div>
          <div class="hint">
            * Ovo je <strong>javna</strong> informacija na vašem profilu i u pretragama. Za precizno spajanje i dalje koristimo vašu <strong>privatnu</strong> lat/lng lokaciju.
          </div>
        </section>

        <!-- Opis + slike -->
        <section class="cloud" aria-labelledby="lab-bio">
          <h4 id="lab-bio">Opis profila</h4>
          <textarea id="bio" placeholder="Tko ste, u čemu ste najbolji, koliko dugo radite, izdvojeni projekti…"></textarea>
          <div class="hint">* Fokusirajte se na ono što klijentu daje povjerenje (iskustvo, certifikati, reference).</div>
          <div class="uploader-minimal">
            <input id="photos" type="file" accept="image/*" multiple hidden>
            <button class="upload-link" id="uploadLink" type="button">📎 Dodaj fotografije</button>
            <div class="upload-grid" id="photoPreview" aria-live="polite"></div>
          </div>
        </section>

        <!-- Recenzije (centrirano) -->
        <section class="cloud center">
          <label class="chip" style="gap:10px">
            <input type="checkbox" id="reviews" checked>
            Dozvoli ostavljanje recenzija
          </label>
        </section>

        <!-- Ne uznemiravaj (samo sati + “Nije potrebno”) -->
        <section class="cloud" aria-labelledby="lab-quiet" id="quietSection">
          <h4 id="lab-quiet">Ne uznemiravaj</h4>
          <div class="row two" id="quietRow">
            <label>Od
              <input type="text"
                     id="quiet_from"
                     inputmode="none"
                     readonly
                     placeholder="—:—"
                     aria-haspopup="true"
                     aria-expanded="false" />
            </label>
            <label>Do
              <input type="text"
                     id="quiet_to"
                     inputmode="none"
                     readonly
                     placeholder="—:—"
                     aria-haspopup="true"
                     aria-expanded="false" />
            </label>
          </div>
          <label style="display:flex; align-items:center; gap:10px; margin-top:10px; user-select:none">
            <input type="checkbox" id="quiet_skip">
            <span>Nije potrebno</span>
          </label>
        </section>

        <!-- Akcije (desno) -->
        <div class="actions" style="margin-top:12px">
          <button id="btnSave" class="btn btn-primary">Kreiraj / Spremi profil</button>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="card" style="padding:16px;margin-top:10px" id="preview" hidden>
        <h3 style="margin:0 0 8px">Pregled</h3>
        <div id="pv" class="muted"></div>
      </div>
    </div>

    <div data-include="promos.html"></div>
    <div data-include="footer.html"></div>
  </main>

  <!-- Toast (zajednički) -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- DIALOG: Zanimanja -->
  <dialog id="dlgSkills">
    <div class="dlg-head">
      <strong>Odaberi zanimanja (max 3)</strong>
      <button class="btn btn-ghost btn-small" onclick="cancelSkillsDialog()">✕</button>
    </div>
    <div class="dlg-body">
      <div class="dlg-search">
        <input id="skillSearch" placeholder="Pretraži ručno..">
      </div>
      <div id="skillList" class="list" role="listbox" aria-multiselectable="true"></div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" type="button" onclick="cancelSkillsDialog()">Odustani</button>
      <button class="btn btn-primary" id="skillsSave" type="button">Spremi</button>
    </div>
  </dialog>

  <!-- DIALOG: Ručni odabir mjesta -->
  <dialog id="dlgPlace">
    <div class="dlg-head">
      <strong>Ručni odabir mjesta</strong>
      <button class="btn btn-ghost btn-small" id="btnPlaceX" type="button">✕</button>
    </div>
    <div class="dlg-body" style="padding:14px 16px; max-height:70vh; overflow:auto">
      <div class="row two">
        <div class="field"><label class="help">Država</label><select id="selCountry"></select></div>
        <div class="field"><label class="help">Grad / Mjesto</label><select id="selCity"></select></div>
      </div>
      <div class="hint" style="margin-top:8px">Sustav će uzeti geografski centroid odabranog mjesta za izračun udaljenosti (privatno, nevidljivo).</div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" id="btnPlaceCancel" type="button">Odustani</button>
      <button class="btn btn-primary" id="placeSave" type="button">Spremi lokaciju</button>
    </div>
  </dialog>

  <!-- Reusable mini popup za sate -->
  <div id="hourPopover" style="position:absolute; inset:auto auto; display:none"></div>

  <script src="include.js"></script>
  <script>
    const $ = s => document.querySelector(s);

    /* ===== Toast helper + preusmjeravanje alert() ===== */
    function toast(msg){
      const t = document.getElementById('toast');
      if(!t) return;
      t.textContent = String(msg || '');
      t.classList.add('show');
      clearTimeout(t._hide);
      t._hide = setTimeout(()=> t.classList.remove('show'), 3000);
    }
    window.alert = (m)=> toast(m);

    /* ========== SKILLS (ISTO KAO TRAŽIM USLUGU) ========== */
    const ALL_SKILLS = [];
    fetch('data/skills.json').then(r=>r.json()).then(list=>{
      const arr = Array.isArray(list) ? list : (Array.isArray(list.skills) ? list.skills : []);
      ALL_SKILLS.push(...arr.sort((a,b)=>a.localeCompare(b,'hr')));
      renderSkillList();
    }).catch(()=>{ /* fallback ako JSON nedostupan */ });

    const pickedSkills = new Set();
    const skillChips  = $('#skillsChips');
    const dlgSkills   = $('#dlgSkills');
    const skillList   = $('#skillList');
    const skillSearch = $('#skillSearch');

    /* snapshot za cancel (skills) */
    let tempSkillsBefore = new Set();

    function renderChips(){
      skillChips.innerHTML='';
      pickedSkills.forEach(s=>{
        const chip=document.createElement('span'); chip.className='chip';
        chip.innerHTML=`<span>${s}</span> <button title="Ukloni" aria-label="Ukloni">✕</button>`;
        chip.querySelector('button').addEventListener('click', ()=>{ pickedSkills.delete(s); renderChips(); updateSkillCount(); });
        skillChips.appendChild(chip);
      });
    }
    function updateSkillCount(){
      const el = document.getElementById('skillCountInfo');
      if (el) el.textContent = `odabrano ${pickedSkills.size}/3`;
    }

    function stripDiacritics(s){ return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,''); }
    function norm(s){ return stripDiacritics((s||'').toLowerCase().trim()); }
    function startsWithWordPrefix(label, query){
      if(!query) return true;
      const L = norm(label), Q = norm(query);
      if(L.startsWith(Q)) return true;
      return L.split(/\s+/).some(w => w.startsWith(Q));
    }

    function renderSkillList(filter=''){
      skillList.innerHTML='';
      const f = (filter||'');
      ALL_SKILLS
        .filter(s => startsWithWordPrefix(s, f))
        .forEach(s=>{
          const row=document.createElement('label'); row.className='item';
          row.innerHTML=`<span>${s}</span><input type="checkbox" ${pickedSkills.has(s)?'checked':''}>`;
          const cb=row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if(cb.checked){
              if(pickedSkills.size>=3){ cb.checked=false; return; }
              pickedSkills.add(s);
            } else {
              pickedSkills.delete(s);
            }
            renderChips(); updateSkillCount();
          });
          skillList.appendChild(row);
        });
    }

    $('#btnPickSkills').addEventListener('click', ()=>{
      tempSkillsBefore = new Set(pickedSkills);
      renderSkillList();
      skillSearch.value='';
      dlgSkills.showModal();
      const body = dlgSkills.querySelector('.dlg-body');
      if (body) body.scrollTop = 0;
      setTimeout(()=>skillSearch.focus(),50);
    });

    $('#skillsSave').addEventListener('click', ()=> dlgSkills.close());

    function cancelSkillsDialog(){
      pickedSkills.clear();
      tempSkillsBefore.forEach(s => pickedSkills.add(s));
      renderChips();
      updateSkillCount();
      dlgSkills.close();
    }
    dlgSkills.addEventListener('cancel', (e)=>{
      e.preventDefault();
      cancelSkillsDialog();
    });

    skillSearch.addEventListener('input', ()=>{
      renderSkillList(skillSearch.value);
      const body = dlgSkills.querySelector('.dlg-body');
      if (body) body.scrollTop = 0;
    });
    skillSearch.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ skillSearch.value=''; renderSkillList(''); const body=dlgSkills.querySelector('.dlg-body'); if(body) body.scrollTop=0; } });

    /* ========== PRIVATNA LOKACIJA (isto kao tražimuslugu) ========== */
    const mapsUrl=$('#mapsUrl'), latEl=$('#lat'), lngEl=$('#lng'), placeLabel=$('#placeLabel');

    const tryParseGoogleMaps=(url)=>{
      const at=/@(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/.exec(url); if(at) return {lat:parseFloat(at[1]), lng:parseFloat(at[2])};
      const d3d=/!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/.exec(url); if(d3d) return {lat:parseFloat(d3d[1]), lng:parseFloat(d3d[2])};
      try{ const u=new URL(url); const q=u.searchParams.get('q'); if(q){ const m=q.match(/(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/); if(m) return {lat:parseFloat(m[1]), lng:parseFloat(m[3])}; } }catch(_){}
      return null;
    };
    function buildGoogleMapsLink(lat, lng, label=''){
      const q = label ? encodeURIComponent(label) : `${lat},${lng}`;
      return `https://maps.google.com/?q=${q}&ll=${lat},${lng}&z=14`;
    }
    $('#openMaps').addEventListener('click', ()=> window.open('https://maps.google.com','_blank'));
    mapsUrl.addEventListener('change', ()=>{
      const val=mapsUrl.value.trim(); const p=tryParseGoogleMaps(val);
      if(p){ latEl.value=p.lat; lngEl.value=p.lng; placeLabel.value=val; alert('Lokacija prepoznata.'); }
      else{ alert('Nije prepoznata lokacija iz linka. Pokušajte drugi oblik ili ručni odabir.'); }
    });

    // Ručni odabir – dijalog
    const dlgPlace=$('#dlgPlace'), selCountry=$('#selCountry'), selCity=$('#selCity');
    const COUNTRY_FILES={
      "BiH": "data/cities-bih.json",
      "Hrvatska": "data/cities-hr.json",
      "Srbija": "data/cities-rs.json",
      "Slovenija": "data/cities-si.json",
      "Crna Gora": "data/cities-me.json",
      "S. Makedonija": "data/cities-mk.json"
    };
    function fillDlgCountries(){ selCountry.innerHTML=Object.keys(COUNTRY_FILES).map(c=>`<option>${c}</option>`).join(''); selCountry.dispatchEvent(new Event('change')); }
    selCountry.addEventListener('change', async ()=>{
      selCity.innerHTML='<option>Učitavam…</option>';
      try{
        const url=COUNTRY_FILES[selCountry.value];
        const list=await (await fetch(url,{cache:'no-cache'})).json();
        list.sort((a,b)=> a.name.localeCompare(b.name,'hr'));
        selCity.innerHTML=list.map(ci=>`<option data-lat="${ci.lat}" data-lng="${ci.lng}">${ci.name}</option>`).join('');
      }catch{ selCity.innerHTML='<option>Greška pri učitavanju</option>'; }
    });

    let placeSnapshot=null;
    function snapshotPlace(){ placeSnapshot={ lat:latEl.value, lng:lngEl.value, label:placeLabel.value, maps:mapsUrl.value }; }
    function cancelPlaceDialog(){
      if(placeSnapshot){ latEl.value=placeSnapshot.lat; lngEl.value=placeSnapshot.lng; placeLabel.value=placeSnapshot.label; mapsUrl.value=placeSnapshot.maps; }
      dlgPlace.close();
    }
    $('#btnManualPlace').addEventListener('click', ()=>{ fillDlgCountries(); snapshotPlace(); dlgPlace.showModal(); });
    $('#btnManualPlace').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fillDlgCountries(); snapshotPlace(); dlgPlace.showModal(); }});
    dlgPlace.addEventListener('cancel', (e)=>{ e.preventDefault(); cancelPlaceDialog(); });
    $('#btnPlaceX').addEventListener('click', (e)=>{ e.preventDefault(); cancelPlaceDialog(); });
    $('#btnPlaceCancel').addEventListener('click', (e)=>{ e.preventDefault(); cancelPlaceDialog(); });
    $('#placeSave').addEventListener('click', ()=>{
      const opt=selCity.selectedOptions[0]; if(!opt){ alert('Odaberite grad.'); return; }
      const lat=parseFloat(opt.dataset.lat), lng=parseFloat(opt.dataset.lng);
      const label = selCountry.value+' / '+selCity.value;
      latEl.value=lat; lngEl.value=lng; placeLabel.value=label;
      mapsUrl.value = buildGoogleMapsLink(lat, lng, label);
      dlgPlace.close(); alert('Lokacija postavljena.');
    });

    /* ========== JAVNO PODRUČJE ========== */
    const P_COUNTRY_FILE = {
      'Bosna i Hercegovina': 'bih',
      'Hrvatska': 'hr',
      'Srbija': 'rs',
      'Crna Gora': 'me',
      'Slovenija': 'si',
      'Sjeverna Makedonija': 'mk'
    };

    async function loadCitiesFor(country){
      const code = P_COUNTRY_FILE[country]; if(!code) return [];
      try{
        const r = await fetch(`data/cities-${code}.json`, { cache:'no-cache' });
        if(!r.ok) throw new Error();
        const list = await r.json();
        return Array.isArray(list) ? list.map(o => o.name) : [];
      }catch(_){ return []; }
    }
    function fillSelect(sel, items, placeholder){
      if(!sel) return;
      sel.innerHTML = '';
      if(placeholder) sel.appendChild(new Option(placeholder, ''));
      items.forEach(v => sel.appendChild(new Option(v, v)));
      sel.disabled = items.length === 0;
    }
    function wireLocationChain(ids){
      const countrySel = document.getElementById(ids.country);
      const citySel    = document.getElementById(ids.city);
      const areaSel    = ids.area ? document.getElementById(ids.area) : null;

      const countries = Object.keys(P_COUNTRY_FILE);
      fillSelect(countrySel, countries.sort((a,b)=>a.localeCompare(b,'hr')), '— odaberite —');

      if (citySel){
        citySel.innerHTML = '<option value="">— prvo odaberite državu —</option>';
        citySel.disabled = true;
      }
      if (areaSel){
        areaSel.innerHTML = '<option value="">— nije obavezno —</option>';
        areaSel.disabled = true;
      }

      countrySel.addEventListener('change', async ()=>{
        const ctry = countrySel.value;
        const cities = (await loadCitiesFor(ctry)).sort((a,b)=>a.localeCompare(b,'hr'));
        if (cities.length){
          fillSelect(citySel, cities, '— odaberite grad —');
          citySel.disabled = false;
        } else {
          citySel.innerHTML = '<option value="">— nema popisa (koristite “Ručni odabir mjesta”) —</option>';
          citySel.disabled = false;
          toast('Nije učitan popis gradova — koristite “Ručni odabir mjesta”.');
        }
        if (areaSel){
          areaSel.innerHTML = '<option value="">— nije obavezno —</option>';
          areaSel.disabled = true;
        }
      });

      if (citySel){
        citySel.addEventListener('change', ()=>{
          if (areaSel){
            areaSel.innerHTML = '<option value="">— nije obavezno —</option>';
            areaSel.disabled = true;
          }
        });
      }
      return { countrySel, citySel, areaSel };
    }

    /* ===== POPUP SATI (00:00 – 23:00) ===== */
    const HOURS = Array.from({length:24}, (_,i)=> String(i).padStart(2,'0') + ':00'); // 00..23

    function showHourPopover(targetInput){
      const pop = document.getElementById('hourPopover');
      pop.innerHTML = '';

      const grid = document.createElement('div');
      grid.className = 'hour-grid';

      const current = (targetInput.value||'').slice(0,5);
      HOURS.forEach(hh => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'hour-btn';
        btn.textContent = hh + 'h';
        btn.setAttribute('data-hour', hh);
        if (current === hh) btn.setAttribute('aria-current','true');
        btn.addEventListener('click', ()=>{
          targetInput.value = hh;
          hideHourPopover();
        });
        grid.appendChild(btn);
      });

      pop.appendChild(grid);

      // Pozicioniraj pop-up iznad inputa
const r = targetInput.getBoundingClientRect();
const popRect = pop.getBoundingClientRect();
const margin = 6;

// izračun iznad
let top = window.scrollY + r.top - popRect.height - margin;
// clamp da ne ode izvan ekrana gore
const minTop = window.scrollY + 8;
if (top < minTop) top = minTop;

// lijevo poravnanje kao input (sa clampom da ne iscuri desno)
let left = window.scrollX + r.left;
const maxLeft = window.scrollX + window.innerWidth - popRect.width - 8;
if (left > maxLeft) left = Math.max(window.scrollX + 8, maxLeft);

pop.style.top  = top + 'px';
pop.style.left = left + 'px';
pop.style.display = 'block';
targetInput.setAttribute('aria-expanded','true');
      
      // Zaključaj body scroll dok je pop-up otvoren
      document.body._prevOverflow = document.body.style.overflow || '';
      document.body.style.overflow = 'hidden';

      setTimeout(()=>{
        const onDown = (e)=>{ if(!pop.contains(e.target)) hideHourPopover(); };
        const onEsc  = (e)=>{ if(e.key==='Escape') hideHourPopover(); };
        document.addEventListener('mousedown', onDown, { once:true });
        document.addEventListener('keydown', onEsc, { once:true });
        pop._cleanup = ()=> {
          document.removeEventListener('mousedown', onDown, { once:true });
          document.removeEventListener('keydown', onEsc, { once:true });
        };
      },0);
    }
    function hideHourPopover(){
      const pop = document.getElementById('hourPopover');
      if (pop._cleanup) pop._cleanup();
      pop.style.display='none';
      const expanded = document.querySelector('[aria-haspopup="true"][aria-expanded="true"]');
      if (expanded) expanded.setAttribute('aria-expanded','false');
      // Vrati body scroll
      if (document.body._prevOverflow !== undefined){
        document.body.style.overflow = document.body._prevOverflow;
        delete document.body._prevOverflow;
      }
    }

    /* === DND wiring (radi odmah, bez obzira na API) === */
    const quietFrom = document.getElementById('quiet_from');
    const quietTo   = document.getElementById('quiet_to');
    const quietSkip = document.getElementById('quiet_skip');
    const quietSec  = document.getElementById('quietSection');

    [quietFrom, quietTo].forEach(inp=>{
      inp.addEventListener('click', ()=>{
        if (quietSkip.checked) return;
        showHourPopover(inp);
      });
      inp.addEventListener('keydown', (e)=> e.preventDefault()); // samo popup
    });

    quietSkip.addEventListener('change', ()=>{
      const on = quietSkip.checked;
      quietSec.classList.toggle('is-disabled', on);
      if (on){ quietFrom.value=''; quietTo.value=''; }
    });

    /* ========== API helper ========== */
    async function api(route, method='GET', body=null){
      const res = await fetch('api/auth.php?route='+route, {
        method, headers:{'Content-Type':'application/json'},
        body: body?JSON.stringify(body):null
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(j.error||'Greška');
      return j;
    }

    /* ========== INIT ========== */
    (async ()=>{
      try{
        renderChips();
        updateSkillCount();

        const pubChain = wireLocationChain({ country:'svcCountry', city:'svcCity' });

        // Učitaj profil
        const { data } = await api('profile','GET');
        if (data){
          email.value     = data.email||'';
          name.value      = data.name||'';
          phone.value     = data.phone||'';

          (Array.isArray(data.skills)? data.skills:[]).slice(0,3).forEach(s=> pickedSkills.add(s));
          renderChips(); updateSkillCount();

          // privatna lokacija
          const latEl = document.getElementById('lat');
          const lngEl = document.getElementById('lng');
          const mapsUrl = document.getElementById('mapsUrl');
          const placeLabel = document.getElementById('placeLabel');

          if (latEl && lngEl){
            latEl.value = data.lat!=null ? String(data.lat) : '';
            lngEl.value = data.lng!=null ? String(data.lng) : '';
          }
          if (mapsUrl) mapsUrl.value = (data.lat!=null && data.lng!=null)
            ? ('https://maps.google.com/?q='+data.lat+','+data.lng+'&ll='+data.lat+','+data.lng+'&z=14')
            : '';
          if (placeLabel) placeLabel.value = data.location || '';

          // opis/ostalo
          bio.value        = data.bio||'';
          reviews.checked  = !!data.reviews_enabled;

          // DND početne vrijednosti iz backenda (bez ponovnog vezanja eventa)
          const skipVal = !!(data.quiet_skip);
          if (skipVal){
            quietSkip.checked = true;
            quietSec.classList.add('is-disabled');
            quietFrom.value = '';
            quietTo.value   = '';
          } else {
            quietSkip.checked = false;
            quietSec.classList.remove('is-disabled');
            quietFrom.value = (typeof data.quiet_from === 'string' ? data.quiet_from : '');
            quietTo.value   = (typeof data.quiet_to   === 'string' ? data.quiet_to   : '');
          }

          // javno područje (država / grad)
          const locLabel = (data.location || '').trim();
          if (locLabel){
            const parts = locLabel.split('/').map(s=>s.trim());
            const cc   = parts[0]||'';
            const city = parts[1]||'';
            if (cc && pubChain.countrySel.querySelector(`option[value="${cc}"]`)){
              pubChain.countrySel.value = cc;
              pubChain.countrySel.dispatchEvent(new Event('change'));
              setTimeout(()=>{
                if (city){
                  pubChain.citySel.value = city;
                  pubChain.citySel.dispatchEvent(new Event('change'));
                }
              }, 60);
            }
          }
        }
      } catch(e){
        console.warn('DEV: api(profile) nije dostupan → ne radim redirect', e);
      }
    })();

    /* ========== UI akcije ========== */
    // Upload
    const photos = document.getElementById('photos');
    const uploadLink = document.getElementById('uploadLink');
    uploadLink?.addEventListener('click', ()=> photos?.click());
    photos?.addEventListener('change', ()=>{
      const grid = document.getElementById('photoPreview'); grid.innerHTML='';
      const files = Array.from(photos.files||[]).slice(0,6);
      files.forEach(f=>{
        const d=document.createElement('div'); d.className='thumb';
        const img=document.createElement('img'); img.alt=f.name; d.appendChild(img);
        const btn=document.createElement('button'); btn.type='button'; btn.textContent='✕'; d.appendChild(btn);
        btn.addEventListener('click', ()=>{ d.remove(); });
        grid.appendChild(d);
        const reader=new FileReader(); reader.onload = e=> img.src=String(e.target.result); reader.readAsDataURL(f);
      });
    });

    // Spremi
    document.getElementById('btnSave').addEventListener('click', async (e)=>{
      e.preventDefault();

      const _skip = document.getElementById('quiet_skip').checked;
      let _from = document.getElementById('quiet_from').value.trim();
      let _to   = document.getElementById('quiet_to').value.trim();

      const payload = {
        name: (name.value||'').trim(),
        phone: (phone.value||'').trim(),
        skills: Array.from(pickedSkills).slice(0,3),
        location: (function(){
          const getVal = (id) => {
            const el = document.getElementById(id);
            return (el && typeof el.value === 'string') ? el.value.trim() : '';
          };
          const c = getVal('svcCountry');
          const g = getVal('svcCity');
          const a = getVal('svcArea'); // ne postoji, ali ne smeta
          return [c,g,a].filter(Boolean).join(' / ');
        })(),
        lat: (document.getElementById('lat').value) ? parseFloat(document.getElementById('lat').value) : null,
        lng: (document.getElementById('lng').value) ? parseFloat(document.getElementById('lng').value) : null,
        bio: (bio.value||'').trim(),
        reviews_enabled: reviews.checked,

        // DND po novom (skip = potpuno isključi u backendu)
        quiet_skip: _skip,
        quiet_from: _skip ? null : (_from || null),
        quiet_to:   _skip ? null : (_to   || null)
      };

      if(!payload.name || !payload.phone){ alert('Ime i telefon su obavezni.'); return; }
      if(payload.skills.length===0){ alert('Odaberite barem jedno zanimanje.'); return; }

      try{
        await api('profile','PUT', payload);

        const pv = document.getElementById('pv');
        const preview = document.getElementById('preview');
        pv.innerHTML = `
          <div><strong>${payload.name}</strong></div>
          <div class="muted">📞 ${payload.phone}</div>
          <div class="muted">🧩 ${payload.skills.join(', ')}</div>
          <div class="muted">📍 ${payload.location || '-'}</div>
          <div class="muted">🌐 ${payload.lat??'-'}, ${payload.lng??'-'}</div>
          <div style="margin-top:6px">${payload.bio?payload.bio.replace(/</g,'&lt;'):'—'}</div>
          <div class="muted" style="margin-top:6px">⭐ Recenzije: ${payload.reviews_enabled?'DA':'NE'}</div>
          <div class="muted">⛔ ${
            payload.quiet_skip ? 'Nije potrebno' :
            ((payload.quiet_from||'—:—') + ' → ' + (payload.quiet_to||'—:—'))
          }</div>
        `;
        preview.hidden = false;
        alert('Profil spremljen. Vaš profil će se prikazati na popisu majstora.');
      }catch(err){ alert(err.message||'Greška spremanja'); }
    });
  </script>
</body>
</html>
