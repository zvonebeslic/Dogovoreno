<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moj profil ‚Äî Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
</head>
<body>
  <div data-include="header.html"></div>

  <main class="container">
    <div class="card" style="padding:16px">
      <h2 style="margin:0 0 8px">Moj profil</h2>
      <form id="profForm" class="grid">
        <label>Ime / obrt* <input id="name" required></label>
        <label>Telefon* <input id="phone" required placeholder="+387 6X XXX XXX"></label>
        <label>E-mail <input id="email" disabled></label>

        <label>Vje≈°tine (zarezom)* <input id="skills" placeholder="npr. Keramiƒçar, Vodoinstalater" required></label>
        <label>Lokacija (opisno) <input id="location" placeholder="npr. Sarajevo, Grbavica"></label>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <label>Lat <input id="lat" placeholder="npr. 43.8563"></label>
          <label>Lng <input id="lng" placeholder="npr. 18.4131"></label>
        </div>
        <button class="btn btn-ghost" type="button" id="btnMyGps">Postavi moju GPS lokaciju</button>
        <div class="help">Lat/Lng koristimo za pretragu najbli≈æih majstora.</div>

        <label>Kratak opis <textarea id="bio" placeholder="Tko ste, ≈°to radite, iskustvo‚Ä¶"></textarea></label>
        <label><input type="checkbox" id="reviews" checked> ≈Ωelim recenzije</label>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <label>Ne uznemiravaj od <input type="time" id="quiet_from" value="18:00"></label>
          <label>do <input type="time" id="quiet_to" value="07:00"></label>
        </div>

        <div style="display:flex;gap:10px">
          <button class="btn btn-primary" type="submit">Spremi profil</button>
          <button class="btn btn-ghost" type="button" id="logout">Odjava</button>
        </div>
      </form>
    </div>

    <div class="card" style="padding:16px" id="preview" hidden>
      <h3 style="margin:0 0 8px">Pregled</h3>
      <pre id="pv" style="white-space:pre-wrap"></pre>
    </div>
  </main>

  <div data-include="ads.html"></div>
  <div data-include="footer.html"></div>
  <script src="include.js"></script>
  <script>
    async function api(route, method='GET', body=null){
      const res = await fetch('api/auth.php?route='+route, {
        method, headers:{'Content-Type':'application/json'},
        body: body?JSON.stringify(body):null
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(j.error||'Gre≈°ka');
      return j;
    }
    const toArr = s => s.split(',').map(x=>x.trim()).filter(Boolean);

    (async ()=>{
      try{
        const { data } = await api('profile','GET');
        if(data){
          email.value     = data.email||'';
          name.value      = data.name||'';
          phone.value     = data.phone||'';
          skills.value    = (data.skills||[]).join(', ');
          location.value  = data.location||'';
          lat.value       = (data.lat ?? '') + '';
          lng.value       = (data.lng ?? '') + '';
          bio.value       = data.bio||'';
          reviews.checked = !!data.reviews_enabled;
          quiet_from.value= data.quiet_from||'18:00';
          quiet_to.value  = data.quiet_to  ||'07:00';
        }
      }catch(e){ alert('Niste prijavljeni.'); location.href='login.html'; }
    })();

    profForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        name: name.value.trim(),
        phone: phone.value.trim(),
        skills: toArr(skills.value),
        location: location.value.trim(),
        lat: lat.value ? parseFloat(lat.value) : null,
        lng: lng.value ? parseFloat(lng.value) : null,
        bio: bio.value.trim(),
        reviews_enabled: reviews.checked,
        quiet_from: quiet_from.value,
        quiet_to: quiet_to.value
      };
      try{
        await api('profile','PUT', payload);
        const t = `üß∞ ${payload.name}\nüìû ${payload.phone}\nüß© ${payload.skills.join(', ')}\nüìç ${payload.location}\nüåê ${payload.lat||'-'}, ${payload.lng||'-'}\nüìù ${payload.bio}\n‚≠ê Recenzije: ${payload.reviews_enabled?'DA':'NE'}\n‚õî ${payload.quiet_from} ‚Üí ${payload.quiet_to}`;
        pv.textContent = t; preview.hidden = false;
        alert('Profil spremljen.');
      }catch(e){ alert(e.message); }
    });

    btnMyGps.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Va≈° preglednik ne podr≈æava GPS.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        lat.value = pos.coords.latitude.toFixed(6);
        lng.value = pos.coords.longitude.toFixed(6);
      }, err=> alert('Ne mo≈æemo dohvatiti lokaciju: '+err.message), {enableHighAccuracy:true, timeout:10000});
    });

    logout.addEventListener('click', async ()=>{
      try{ await api('logout'); }catch(_){}
      location.href='login.html';
    });
  </script>
</body>
</html>
