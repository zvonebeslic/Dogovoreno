<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moj profil ‚Äî Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
  <style>
    :root{
      --bg:#0f1115; --ink:#0b1220; --muted:#334155;
      --cta:#2563eb; --accent:#16a34a;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    body{ background:#0f1115; color:#f7f8fa; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    .page{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto; }
    .page-wrap{ max-width:980px; margin:18px auto 64px; padding:0 16px; }

    /* Cloud ‚Äì svijetla kartica kao na trazimuslugu.html */
    .cloud{
      background: linear-gradient(180deg, rgba(255,255,255,.78) 0%, rgba(246,247,249,.72) 100%);
      backdrop-filter: blur(4px);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), 0 8px 22px rgba(0,0,0,.22);
      padding:16px; margin:12px 0; color:var(--ink);
    }
    .cloud h3,.cloud h4{ margin:0 0 10px; font-size:18px; color:#0b1220 }
    .lead, .muted{ color:#c7cbd4 }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px }
    .row{ display:grid; gap:10px }
    .row.two{ grid-template-columns:1fr 1fr }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }

    /* Chip identiƒçan tra≈æimuslugu */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.6);
      font-weight:600; color:#0b1220;
    }
    .chip button{ all:unset; cursor:pointer; opacity:.85 }
    .chip button:hover{ opacity:1 }

    /* Bijeli inputi/textarea/select/time (crni tekst) ‚Äì isto kao na trazimuslugu */
    .cloud input[type="text"],
    .cloud input[type="url"],
    .cloud input[type="search"],
    .cloud input[type="time"],
    .cloud select,
    .cloud textarea{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff; color:#0b1220;
      outline:none; font-family:inherit;
    }
    .cloud textarea{ min-height:140px; resize:vertical }
    .cloud input:focus,
    .cloud select:focus,
    .cloud textarea:focus{
      outline:2px solid rgba(37,99,235,.25);
      border-color:rgba(37,99,235,.45);
    }
    .cloud input::placeholder,
    .cloud textarea::placeholder{ color:#64748b; }

    /* Gumbi ‚Äì kao na trazimuslugu */
    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer }
    .btn-primary{
      background:linear-gradient(180deg, #2b6ee9 0%, #245ed0 100%);
      color:#fff; border:1px solid rgba(0,0,0,.2);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.15), 0 6px 16px rgba(37,99,235,.28);
      transition: transform .08s ease;
    }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-ghost{ background:transparent; color:#ffffff; border:2px solid #ffffff; }
    .btn-accent{
      background: linear-gradient(180deg, #16a34a 0%, #0f8a3a 55%, #0b6f30 100%);
      color:#e6fff4; border:1px solid rgba(0,0,0,.35);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 6px 16px rgba(16,163,74,.25);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn-accent:hover{ filter:brightness(1.03); box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 8px 20px rgba(16,163,74,.32); }
    .btn-accent:active{ transform: translateY(1px); box-shadow: inset 0 2px 4px rgba(0,0,0,.25), 0 3px 10px rgba(16,163,74,.22); }
    .btn-small{ padding:8px 10px; border-radius:10px }

    /* Linklike kao na trazimuslugu */
    .linklike{ color:#1f3b7c; text-decoration:underline; cursor:pointer }

    /* Dialog ‚Äì tamni kao na trazimuslugu */
    dialog{ border:0; border-radius:16px; background:#0e1014; color:#f7f8fa; width:min(720px, 96vw) }
    dialog::backdrop{ background:rgba(0,0,0,.4) }
    .dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    .dlg-body{ padding:0; max-height:70vh; overflow:auto; overscroll-behavior:contain; }
    .dlg-actions{ padding:14px 16px; display:flex; gap:10px; justify-content:center; border-top:1px solid rgba(255,255,255,.08) }
    .dlg-search{ position:sticky; top:0; z-index:2; background:#0e1014; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    #skillSearch{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b0d11; color:#fff }

    /* Lista stavki u popupu (isti vizual) */
    .list{ display:grid; gap:8px; padding:14px 16px; min-height:35vh; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03); }
    .item input{ transform:scale(1.2) }

    /* DlgPlace ‚Äì svijetli kao na trazimuslugu */
    #dlgPlace{
      background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(246,247,249,.86) 100%);
      color:#0b1220;
    }
    #dlgPlace .dlg-head{ border-bottom:1px solid rgba(0,0,0,.08); }
    #dlgPlace .dlg-actions{ border-top:1px solid rgba(0,0,0,.08); }
    #dlgPlace .field select,
    #dlgPlace .field input[type="text"],
    #dlgPlace .field input[type="url"],
    #dlgPlace .field input[type="search"]{
      background:#ffffff; color:#0b1220;
      border:1px solid rgba(0,0,0,.15);
      border-radius:12px; padding:10px 12px; outline:none;
      font-family:inherit; font-size:inherit;
    }
    #dlgPlace .field select:focus,
    #dlgPlace .field input:focus{
      outline:2px solid rgba(37,99,235,.25);
      border-color:rgba(37,99,235,.45);
    }
    #dlgPlace .help, #dlgPlace .note{ color:#0b1220; }
    #dlgPlace .btn-ghost{
      background:transparent; color:#0b1220; border:1px solid rgba(0,0,0,.20);
    }
    #dlgPlace .btn-ghost:hover{ background:rgba(0,0,0,.05); }

    /* Upload ‚Äì identiƒçan */
    .uploader-minimal{ margin:8px 0 0; }
    .upload-link{ appearance:none; background:transparent; border:0; text-decoration:underline; cursor:pointer; padding:4px 0; font-weight:600; color:#f7f8fa; }
    .cloud .upload-link{ color:#0b1220; }
    .upload-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:10px; margin-top:8px; }
    .thumb{ position:relative; border-radius:10px; overflow:hidden; background:#0b0d11; border:1px solid rgba(255,255,255,.12); }
    .cloud .thumb{ background:#ffffff; border:1px solid rgba(0,0,0,.12); }
    .thumb img{ width:100%; height:72px; object-fit:cover; display:block }
    .thumb button{ position:absolute; top:6px; right:6px; border:0; border-radius:8px; padding:4px 6px; background:rgba(0,0,0,.5); color:#fff; cursor:pointer; }

    /* Akcije kao na tra≈æimuslugu (desno) */
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
  </style>
</head>
<body>
  <main class="page">
    <div data-include="header.html"></div>

    <div class="page-wrap">
      <div class="card" style="padding:16px">
        <h2 style="font-weight:600; font-size:clamp(18px,3vw,26px); color:#f7f8fa; margin:0">Moj profil</h2>
        <div class="muted" style="color:#c7cbd4; font-size:clamp(13px,2.5vw,16px); margin-bottom:8px">(profil za one koji nude usluge)</div>

        <!-- Ime / obrt / firma -->
        <section class="cloud" aria-labelledby="lab-name">
          <h4 id="lab-name">Ime / Obrt / Firma *</h4>
          <input id="name" type="text" required placeholder="npr. Marko Markoviƒá / Obrt MarkoGradnja / XYZ d.o.o.">
          <div class="hint">* Unesite svoje ime, ili ime obrta, ili ime firme.</div>
        </section>

        <!-- Telefon -->
        <section class="cloud" aria-labelledby="lab-phone">
          <h4 id="lab-phone">Broj mob/tel *</h4>
          <input id="phone" type="text" required placeholder="+387 6X XXX XXX / +385 9X XXX XXXX">
          <div class="hint">* Napi≈°ite predbroj.</div>
        </section>

        <!-- E-mail (kontaktni) -->
        <section class="cloud" aria-labelledby="lab-email">
          <h4 id="lab-email">E-mail</h4>
          <input id="email" type="text" required placeholder="email@primjer.com" disabled>
          <div class="hint">* E-mail koristimo za obavijesti. Promijeniti ga mo≈æete u postavkama raƒçuna.</div>
        </section>

        <!-- Zanimanja ‚Äì identiƒçan UX kao na Tra≈æim uslugu -->
        <section class="cloud" aria-labelledby="lab-skill">
          <h4 id="lab-skill">≈†to ste po zanimanju?</h4>
          <div class="row">
            <div id="skillsChips" class="chips" aria-live="polite"></div>
               <div style="display:flex;align-items:center;gap:8px">
  <button id="btnPickSkills" type="button" class="btn btn-accent btn-small">Odaberi zanimanja</button>
  </div>
            <div class="hint">* Odaberite zanimanje iz popisa. Max. 3 zanimanja po profilu.</div>
          </div>
        </section>

        <!-- Lokacija (privatno za match) -->
        <section class="cloud" aria-labelledby="lab-loc">
          <h4 id="lab-loc">Gdje ≈æelite da vas se pronaƒëe? (privatno)</h4>
          <div class="row">
            <label class="help">Zalijepite link s Google karata (preporuƒçeno)</label>
            <input id="mapsUrl" type="url" placeholder="https://maps.google.com/‚Ä¶">
            <div class="help">
              <span class="linklike" id="openMaps">Otvori Google karte</span>
              ¬∑
              <span class="linklike" id="btnManualPlace" role="button" tabindex="0">Ruƒçni odabir mjesta</span>
            </div>
          </div>
          <div class="hint" style="margin-top:8px">
           * Va≈°a ƒáe lokacija ovdje ostati <b>uvijek tajna</b> i nitko je neƒáe vidjeti. Koristimo je samo za precizan match s klijentima.
          </div>
          <input type="hidden" id="lat"><input type="hidden" id="lng"><input type="hidden" id="placeLabel">
        </section>

        <!-- Podruƒçje djelovanja (JAVNO) -->
        <section class="cloud" aria-labelledby="lab-public">
          <h4 id="lab-public">Podruƒçje djelovanja (javna informacija na profilu)</h4>
          <div class="row two">
            <label>Dr≈æava
              <select id="svcCountry">
                <option value="">‚Äî odaberite ‚Äî</option>
              </select>
            </label>
            <label>Grad / mjesto
              <select id="svcCity" disabled>
                <option value="">‚Äî prvo odaberite dr≈æavu ‚Äî</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <label>Naselje / kvart (opcija)
              <select id="svcArea" disabled>
                <option value="">‚Äî nije obavezno ‚Äî</option>
              </select>
            </label>
          </div>
          <div class="hint">
           * Ovo je <strong>javna</strong> informacija na va≈°em profilu i u pretragama. Za precizno spajanje i dalje koristimo va≈°u <strong>privatnu</strong> lat/lng lokaciju.
          </div>
        </section>

        <!-- Opis + slike -->
        <section class="cloud" aria-labelledby="lab-bio">
          <h4 id="lab-bio">Opis profila</h4>
          <textarea id="bio" placeholder="Tko ste, u ƒçemu ste najbolji, koliko dugo radite, izdvojeni projekti‚Ä¶"></textarea>
          <div class="hint">* Fokusirajte se na ono ≈°to klijentu daje povjerenje (iskustvo, certifikati, reference).</div>
          <div class="uploader-minimal">
            <input id="photos" type="file" accept="image/*" multiple hidden>
            <button class="upload-link" id="uploadLink" type="button">üìé Dodaj fotografije</button>
            <div class="upload-grid" id="photoPreview" aria-live="polite"></div>
          </div>
        </section>

        <!-- Recenzije -->
        <section class="cloud">
          <label class="chip" style="gap:10px">
            <input type="checkbox" id="reviews" checked>
            Dozvoli ostavljanje recenzija
          </label>
        </section>

        <!-- Ne uznemiravaj -->
        <section class="cloud" aria-labelledby="lab-quiet">
          <h4 id="lab-quiet">Ne uznemiravaj</h4>
          <div class="row two">
            <label>Od <input type="time" id="quiet_from" value="18:00"></label>
            <label>Do <input type="time" id="quiet_to" value="07:00"></label>
          </div>
        </section>

        <!-- Akcije (desno) -->
        <div class="actions" style="margin-top:12px">
          <button id="btnSave" class="btn btn-primary">Kreiraj / Spremi profil</button>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="card" style="padding:16px;margin-top:10px" id="preview" hidden>
        <h3 style="margin:0 0 8px">Pregled</h3>
        <div id="pv" class="muted"></div>
      </div>
    </div>

    <div data-include="promos.html"></div>
    <div data-include="footer.html"></div>
  </main>

  <!-- DIALOG: Zanimanja (IDENTIƒåAN kao na Tra≈æim uslugu) -->
  <dialog id="dlgSkills">
    <div class="dlg-head">
      <strong>Odaberi zanimanja (max 3)</strong>
      <button class="btn btn-ghost btn-small" onclick="cancelSkillsDialog()">‚úï</button>
    </div>
    <div class="dlg-body">
      <div class="dlg-search">
        <input id="skillSearch" placeholder="Pretra≈æi ruƒçno..">
      </div>
      <div id="skillList" class="list" role="listbox" aria-multiselectable="true"></div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" type="button" onclick="cancelSkillsDialog()">Odustani</button>
      <button class="btn btn-primary" id="skillsSave" type="button">Spremi</button>
    </div>
  </dialog>

  <!-- DIALOG: Ruƒçni odabir mjesta (isti kao na tra≈æimuslugu) -->
  <dialog id="dlgPlace">
    <div class="dlg-head">
      <strong>Ruƒçni odabir mjesta</strong>
      <button class="btn btn-ghost btn-small" id="btnPlaceX" type="button">‚úï</button>
    </div>
    <div class="dlg-body" style="padding:14px 16px; max-height:70vh; overflow:auto">
      <div class="row two">
        <div class="field"><label class="help">Dr≈æava</label><select id="selCountry"></select></div>
        <div class="field"><label class="help">Grad / Mjesto</label><select id="selCity"></select></div>
      </div>
      <div class="hint" style="margin-top:8px">Sustav koristi centroid odabranog mjesta za izraƒçun udaljenosti (privatno, nevidljivo).</div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" id="btnPlaceCancel" type="button">Odustani</button>
      <button class="btn btn-primary" id="placeSave" type="button">Spremi lokaciju</button>
    </div>
  </dialog>

  <script src="include.js"></script>
  <script>
    const $ = s => document.querySelector(s);

    /* ========== SKILLS (ISTO KAO TRA≈ΩIM USLUGU) ========== */
    const ALL_SKILLS = [];
    fetch('data/skills.json').then(r=>r.json()).then(list=>{
      const arr = Array.isArray(list) ? list : (Array.isArray(list.skills) ? list.skills : []);
      ALL_SKILLS.push(...arr.sort((a,b)=>a.localeCompare(b,'hr')));
      renderSkillList();
    }).catch(()=>{ /* fallback ako JSON nedostupan */ });

    const pickedSkills = new Set();
    const skillChips  = $('#skillsChips');
    const dlgSkills   = $('#dlgSkills');
    const skillList   = $('#skillList');
    const skillSearch = $('#skillSearch');

    /* snapshot za cancel (skills) */
    let tempSkillsBefore = new Set();

    function renderChips(){
      skillChips.innerHTML='';
      pickedSkills.forEach(s=>{
        const chip=document.createElement('span'); chip.className='chip';
        chip.innerHTML=`<span>${s}</span> <button title="Ukloni" aria-label="Ukloni">‚úï</button>`;
        chip.querySelector('button').addEventListener('click', ()=>{ pickedSkills.delete(s); renderChips(); updateSkillCount(); });
        skillChips.appendChild(chip);
      });
    }
    function updateSkillCount(){
  const el = document.getElementById('skillCountInfo');
  if (el) el.textContent = `odabrano ${pickedSkills.size}/3`;
}
    
    /* HR prefiks pretraga (ƒç/ƒá/≈°/≈æ/ƒë) */
    function stripDiacritics(s){ return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,''); }
    function norm(s){ return stripDiacritics((s||'').toLowerCase().trim()); }
    function startsWithWordPrefix(label, query){
      if(!query) return true;
      const L = norm(label), Q = norm(query);
      if(L.startsWith(Q)) return true;
      return L.split(/\s+/).some(w => w.startsWith(Q));
    }

    function renderSkillList(filter=''){
      skillList.innerHTML='';
      const f = (filter||'');
      ALL_SKILLS
        .filter(s => startsWithWordPrefix(s, f))
        .forEach(s=>{
          const row=document.createElement('label'); row.className='item';
          row.innerHTML=`<span>${s}</span><input type="checkbox" ${pickedSkills.has(s)?'checked':''}>`;
          const cb=row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if(cb.checked){
              if(pickedSkills.size>=3){ cb.checked=false; return; }
              pickedSkills.add(s);
            } else {
              pickedSkills.delete(s);
            }
            renderChips(); updateSkillCount();
          });
          skillList.appendChild(row);
        });
    }

    /* otvaranje skills dijaloga + snapshot */
    $('#btnPickSkills').addEventListener('click', ()=>{
      tempSkillsBefore = new Set(pickedSkills);  // snapshot prije otvaranja
      renderSkillList();
      skillSearch.value='';
      dlgSkills.showModal();
      const body = dlgSkills.querySelector('.dlg-body');
      if (body) body.scrollTop = 0;
      setTimeout(()=>skillSearch.focus(),50);
    });

    /* Spremi = zadr≈æi izmjene */
    $('#skillsSave').addEventListener('click', ()=> dlgSkills.close());

    /* Cancel logika (Odustani, ‚úï, ESC) */
    function cancelSkillsDialog(){
      pickedSkills.clear();
      tempSkillsBefore.forEach(s => pickedSkills.add(s));
      renderChips();
      updateSkillCount();
      dlgSkills.close();
    }
    dlgSkills.addEventListener('cancel', (e)=>{
      e.preventDefault();
      cancelSkillsDialog();
    });

    /* Reset skrola NA SVAKI unos ‚Äì da input uvijek ostane pri vrhu */
    skillSearch.addEventListener('input', ()=>{
      renderSkillList(skillSearch.value);
      const body = dlgSkills.querySelector('.dlg-body');
      if (body) body.scrollTop = 0;
    });
    /* ESC u searchu bri≈°e upit */
    skillSearch.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ skillSearch.value=''; renderSkillList(''); const body=dlgSkills.querySelector('.dlg-body'); if(body) body.scrollTop=0; } });

    /* ========== PRIVATNA LOKACIJA (isto kao tra≈æimuslugu) ========== */
    const mapsUrl=$('#mapsUrl'), latEl=$('#lat'), lngEl=$('#lng'), placeLabel=$('#placeLabel');

    const tryParseGoogleMaps=(url)=>{
      const at=/@(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/.exec(url); if(at) return {lat:parseFloat(at[1]), lng:parseFloat(at[2])};
      const d3d=/!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/.exec(url); if(d3d) return {lat:parseFloat(d3d[1]), lng:parseFloat(d3d[2])};
      try{ const u=new URL(url); const q=u.searchParams.get('q'); if(q){ const m=q.match(/(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/); if(m) return {lat:parseFloat(m[1]), lng:parseFloat(m[3])}; } }catch(_){}
      return null;
    };
    function buildGoogleMapsLink(lat, lng, label=''){
      const q = label ? encodeURIComponent(label) : `${lat},${lng}`;
      return `https://maps.google.com/?q=${q}&ll=${lat},${lng}&z=14`;
    }
    $('#openMaps').addEventListener('click', ()=> window.open('https://maps.google.com','_blank'));
    mapsUrl.addEventListener('change', ()=>{
      const val=mapsUrl.value.trim(); const p=tryParseGoogleMaps(val);
      if(p){ latEl.value=p.lat; lngEl.value=p.lng; placeLabel.value=val; alert('Lokacija prepoznata.'); }
      else{ alert('Nije prepoznata lokacija iz linka. Poku≈°ajte drugi oblik ili ruƒçni odabir.'); }
    });

    // Ruƒçni odabir ‚Äì dijalog (isti dataset kao i prije)
    const dlgPlace=$('#dlgPlace'), selCountry=$('#selCountry'), selCity=$('#selCity');
    const COUNTRY_FILES={
      "BiH": "data/cities-bih.json",
      "Hrvatska": "data/cities-hr.json",
      "Srbija": "data/cities-rs.json",
      "Slovenija": "data/cities-si.json",
      "Crna Gora": "data/cities-me.json",
      "S. Makedonija": "data/cities-mk.json"
    };
    function fillDlgCountries(){ selCountry.innerHTML=Object.keys(COUNTRY_FILES).map(c=>`<option>${c}</option>`).join(''); selCountry.dispatchEvent(new Event('change')); }
    selCountry.addEventListener('change', async ()=>{
      selCity.innerHTML='<option>Uƒçitavam‚Ä¶</option>';
      try{
        const url=COUNTRY_FILES[selCountry.value];
        const list=await (await fetch(url,{cache:'no-cache'})).json();
        list.sort((a,b)=> a.name.localeCompare(b.name,'hr'));
        selCity.innerHTML=list.map(ci=>`<option data-lat="${ci.lat}" data-lng="${ci.lng}">${ci.name}</option>`).join('');
      }catch{ selCity.innerHTML='<option>Gre≈°ka pri uƒçitavanju</option>'; }
    });

    let placeSnapshot=null;
    function snapshotPlace(){ placeSnapshot={ lat:latEl.value, lng:lngEl.value, label:placeLabel.value, maps:mapsUrl.value }; }
    function cancelPlaceDialog(){
      if(placeSnapshot){ latEl.value=placeSnapshot.lat; lngEl.value=placeSnapshot.lng; placeLabel.value=placeSnapshot.label; mapsUrl.value=placeSnapshot.maps; }
      dlgPlace.close();
    }
    $('#btnManualPlace').addEventListener('click', ()=>{ fillDlgCountries(); snapshotPlace(); dlgPlace.showModal(); });
    $('#btnManualPlace').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fillDlgCountries(); snapshotPlace(); dlgPlace.showModal(); }});
    dlgPlace.addEventListener('cancel', (e)=>{ e.preventDefault(); cancelPlaceDialog(); });
    $('#btnPlaceX').addEventListener('click', (e)=>{ e.preventDefault(); cancelPlaceDialog(); });
    $('#btnPlaceCancel').addEventListener('click', (e)=>{ e.preventDefault(); cancelPlaceDialog(); });
    $('#placeSave').addEventListener('click', ()=>{
      const opt=selCity.selectedOptions[0]; if(!opt){ alert('Odaberite grad.'); return; }
      const lat=parseFloat(opt.dataset.lat), lng=parseFloat(opt.dataset.lng);
      const label = selCountry.value+' / '+selCity.value;
      latEl.value=lat; lngEl.value=lng; placeLabel.value=label;
      mapsUrl.value = buildGoogleMapsLink(lat, lng, label);
      dlgPlace.close(); alert('Lokacija postavljena.');
    });

    /* ========== JAVNO PODRUƒåJE ========== */
    const P_COUNTRY_FILE = {
      'Bosna i Hercegovina': 'bih',
      'Hrvatska': 'hr',
      'Srbija': 'rs',
      'Crna Gora': 'mn',
      'Slovenija': 'si',
      'Sjeverna Makedonija': 'mk'
    };
    async function loadCitiesFor(country){
      const code = P_COUNTRY_FILE[country]; if(!code) return [];
      try{
        const r = await fetch(`data/cities-${code}.json`, {cache:'no-cache'});
        if(!r.ok) throw new Error();
        const list = await r.json(); // [{name,lat,lng},...]
        return Array.isArray(list) ? list.map(o=>o.name) : [];
      }catch(_){ return []; }
    }
    function fillSelect(sel, items, placeholder){
      sel.innerHTML=''; if(placeholder) sel.appendChild(new Option(placeholder,''));
      items.forEach(v=> sel.appendChild(new Option(v, v)));
      sel.disabled = items.length===0;
    }
    function wireLocationChain(ids){
      const countrySel = document.getElementById(ids.country);
      const citySel    = document.getElementById(ids.city);
      const areaSel    = document.getElementById(ids.area);

      const countries = Object.keys(P_COUNTRY_FILE);
      fillSelect(countrySel, countries.sort((a,b)=>a.localeCompare(b,'hr')), '‚Äî odaberite ‚Äî');
      citySel.innerHTML = '<option value="">‚Äî prvo odaberite dr≈æavu ‚Äî</option>'; citySel.disabled = true;
      areaSel.innerHTML = '<option value="">‚Äî nije obavezno ‚Äî</option>'; areaSel.disabled = true;

      countrySel.addEventListener('change', async ()=>{
        const ctry = countrySel.value;
        const cities = await loadCitiesFor(ctry);
        fillSelect(citySel, cities.sort((a,b)=>a.localeCompare(b,'hr')), cities.length?'‚Äî odaberite grad ‚Äî':'‚Äî nema gradova ‚Äî');
        areaSel.innerHTML = '<option value="">‚Äî nije obavezno ‚Äî</option>'; areaSel.disabled = true;
      });
      citySel.addEventListener('change', ()=>{
        areaSel.innerHTML = '<option value="">‚Äî nije obavezno ‚Äî</option>'; areaSel.disabled = true;
      });

      return { countrySel, citySel, areaSel };
    }

    /* ========== Upload ========== */
    const photos = document.getElementById('photos');
    const uploadLink = document.getElementById('uploadLink');
    uploadLink?.addEventListener('click', ()=> photos?.click());
    photos?.addEventListener('change', ()=>{
      const grid = document.getElementById('photoPreview'); grid.innerHTML='';
      const files = Array.from(photos.files||[]).slice(0,6);
      files.forEach(f=>{
        const d=document.createElement('div'); d.className='thumb';
        const img=document.createElement('img'); img.alt=f.name; d.appendChild(img);
        const btn=document.createElement('button'); btn.type='button'; btn.textContent='‚úï'; d.appendChild(btn);
        btn.addEventListener('click', ()=>{ d.remove(); });
        grid.appendChild(d);
        const reader=new FileReader(); reader.onload = e=> img.src=String(e.target.result); reader.readAsDataURL(f);
      });
    });

    /* ========== API helper ========== */
    async function api(route, method='GET', body=null){
      const res = await fetch('api/auth.php?route='+route, {
        method, headers:{'Content-Type':'application/json'},
        body: body?JSON.stringify(body):null
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(j.error||'Gre≈°ka');
      return j;
    }

    /* ========== INIT ========== */
    (async ()=>{
      try{
        renderChips(); updateSkillCount();

        // Public area selects
        const pubChain  = wireLocationChain({ country:'svcCountry', city:'svcCity', area:'svcArea' });

        // Uƒçitaj profil
        const { data } = await api('profile','GET');
        if(data){
          email.value     = data.email||'';
          name.value      = data.name||'';
          phone.value     = data.phone||'';

          (Array.isArray(data.skills)? data.skills:[]).slice(0,3).forEach(s=> pickedSkills.add(s));
          renderChips(); updateSkillCount();

          // privatna lokacija
          const latEl = document.getElementById('lat');
          const lngEl = document.getElementById('lng');
          const mapsUrl = document.getElementById('mapsUrl');
          const placeLabel = document.getElementById('placeLabel');

          if(latEl && lngEl){
            latEl.value = data.lat!=null ? String(data.lat) : '';
            lngEl.value = data.lng!=null ? String(data.lng) : '';
          }
          if(mapsUrl) mapsUrl.value = (data.lat!=null && data.lng!=null) ? ('https://maps.google.com/?q='+data.lat+','+data.lng+'&ll='+data.lat+','+data.lng+'&z=14') : '';
          if(placeLabel) placeLabel.value= data.location || '';

          // opis/ostalo
          bio.value       = data.bio||'';
          reviews.checked = !!data.reviews_enabled;
          quiet_from.value= data.quiet_from||'18:00';
          quiet_to.value  = data.quiet_to  ||'07:00';

          // javno podruƒçje
          const locLabel = (data.location || '').trim();
          if(locLabel){
            const parts = locLabel.split('/').map(s=>s.trim());
            const cc   = parts[0]||'';
            const city = parts[1]||'';
            const area = parts[2]||'';
            if(cc && pubChain.countrySel.querySelector(`option[value="${cc}"]`)){
              pubChain.countrySel.value = cc;
              pubChain.countrySel.dispatchEvent(new Event('change'));
              setTimeout(()=>{
                if(city){ pubChain.citySel.value = city; pubChain.citySel.dispatchEvent(new Event('change')); }
                if(area){ pubChain.areaSel.value = area; }
              }, 60);
            }
          }
        }
      }catch(e){
        alert('Prijavite se ili registrirajte kako biste uredili profil.');
        const btn = document.getElementById('authBtn');
        if(btn){ btn.click(); }
        else { location.href = 'index.html#auth'; }
      }
    })();

    /* ========== UI akcije ========== */
    // (skills handlers su gore veƒá postavljeni)

    // Spremi
    document.getElementById('btnSave').addEventListener('click', async (e)=>{
      e.preventDefault();

      const payload = {
        name: (name.value||'').trim(),
        phone: (phone.value||'').trim(),
        skills: Array.from(pickedSkills).slice(0,3),
        location: (function(){
          const c = (document.getElementById('svcCountry').value||'').trim();
          const g = (document.getElementById('svcCity').value||'').trim();
          const a = (document.getElementById('svcArea').value||'').trim();
          return [c,g,a].filter(Boolean).join(' / ');
        })(),
        lat: (document.getElementById('lat').value) ? parseFloat(document.getElementById('lat').value) : null,
        lng: (document.getElementById('lng').value) ? parseFloat(document.getElementById('lng').value) : null,
        bio: (bio.value||'').trim(),
        reviews_enabled: reviews.checked,
        quiet_from: quiet_from.value || '18:00',
        quiet_to: quiet_to.value   || '07:00'
      };

      if(!payload.name || !payload.phone){ alert('Ime i telefon su obavezni.'); return; }
      if(payload.skills.length===0){ alert('Odaberite barem jedno zanimanje.'); return; }

      try{
        await api('profile','PUT', payload);
        const pv = document.getElementById('pv');
        const preview = document.getElementById('preview');
        pv.innerHTML = `
          <div><strong>${payload.name}</strong></div>
          <div class="muted">üìû ${payload.phone}</div>
          <div class="muted">üß© ${payload.skills.join(', ')}</div>
          <div class="muted">üìç ${payload.location || '-'}</div>
          <div class="muted">üåê ${payload.lat??'-'}, ${payload.lng??'-'}</div>
          <div style="margin-top:6px">${payload.bio?payload.bio.replace(/</g,'&lt;'):'‚Äî'}</div>
          <div class="muted" style="margin-top:6px">‚≠ê Recenzije: ${payload.reviews_enabled?'DA':'NE'}</div>
          <div class="muted">‚õî ${payload.quiet_from} ‚Üí ${payload.quiet_to}</div>
        `;
        preview.hidden = false;
        alert('Profil spremljen. Va≈° profil ƒáe se prikazati na popisu majstora.');
      }catch(err){ alert(err.message||'Gre≈°ka spremanja'); }
    });
  </script>
</body>
</html>
