<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pronađi majstora — Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
  <style>
    :root{ --glass:rgba(255,255,255,.08); --muted:#c7cbd4; --fieldBorder:rgba(255,255,255,.12); --cta:#2563eb; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); }
    .wrap{ max-width:1024px; margin:18px auto 64px; padding:0 16px; }
    .h1{ font-weight:800; font-size:clamp(22px,3.8vw,30px); margin:10px 0 6px }
    .lead{ margin:0 0 16px; color:var(--muted) }

    .filters{ background:var(--glass); border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:16px; margin-bottom:14px }
    .row{ display:grid; gap:10px }
    @media(min-width:760px){ .row-4{ grid-template-columns:1fr 1fr 1fr 1fr } }

    .help{ color:var(--muted) }
    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; box-shadow:var(--shadow) }
    .btn-primary{ background:var(--cta); color:#fff }
    .btn-ghost{ background:transparent; color:inherit; border:1px solid var(--fieldBorder) }
    .btn-inline{ padding:8px 10px; border-radius:10px }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); font-weight:600; }
    .chip button{ all:unset; cursor:pointer; opacity:.85 } .chip button:hover{ opacity:1 }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 }
    .toolbar .spacer{ flex:1 }
    .count{ color:var(--muted); font-size:14px }

    .results{ display:grid; gap:12px; }
    @media(min-width:720px){ .results{ grid-template-columns:1fr 1fr } }
    .card-pad{ padding:16px }

    .prov-head{ display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
    .prov-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .muted{ color:var(--muted) }
    .distance{ font-size:12px; color:var(--muted) }
    .badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--fieldBorder); border-radius:999px; padding:4px 8px; font-size:12px; background:rgba(255,255,255,.06) }

    .pagination{ display:flex; gap:8px; align-items:center; justify-content:center; margin-top:14px }
    .page-btn{ border:1px solid var(--fieldBorder); background:rgba(255,255,255,.04); border-radius:10px; padding:8px 12px; cursor:pointer }
    .page-info{ color:var(--muted); font-size:14px }

    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#0b7; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); display:none; z-index:60; }
    .toast.show{ display:block }

    dialog{ border:0; border-radius:16px; background:#0e1014; color:#f7f8fa; width:min(560px, 96vw) }
    dialog::backdrop{ background:rgba(0,0,0,.4) }
    .dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    .dlg-body{ padding:14px 16px; }
    .dlg-actions{ padding:14px 16px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid rgba(255,255,255,.08) }
  </style>
</head>
<body>
  <div data-include="header.html"></div>

  <main class="wrap">
    <h1 class="h1">Pronađi majstora</h1>
    <p class="lead">Filtriraj po području i vještinama. Klikom “Pošalji upit” šalješ poruku izravno odabranom profilu.</p>

    <!-- FILTERI -->
    <section class="filters">
      <div class="row row-4">
        <label>Država
          <select id="fCountry"></select>
        </label>
        <label>Grad / mjesto
          <select id="fCity" disabled></select>
        </label>
        <label>Radijus
          <select id="fRadius">
            <option value="5">↔ do 5 km</option>
            <option value="10">↔ do 10 km</option>
            <option value="25" selected>↔ do 25 km</option>
            <option value="50">↔ do 50 km</option>
            <option value="100">↔ do 100 km</option>
          </select>
        </label>
        <label>Vještina
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnPickSkill" class="btn btn-ghost" type="button">Odaberi</button>
            <div id="skillOne" class="chips" aria-live="polite"></div>
          </div>
          <div class="help">Opcionalno (1 vještina). Ako si došao s <em>Tražim uslugu</em>, već je popunjeno.</div>
        </label>
      </div>

      <div class="toolbar">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnSearch" class="btn btn-primary" disabled>Prikaži majstore</button>
          <button id="btnClear" class="btn btn-ghost">Očisti</button>
        </div>

        <div class="spacer"></div>

        <label>Sortiraj
          <select id="sortBy">
            <option value="dist">Udaljenost (najbliže)</option>
            <option value="name">Ime (A–Ž)</option>
            <option value="updated">Ažurirano (novo → staro)</option>
          </select>
        </label>

        <div id="locInfo" class="count"></div>
      </div>

      <div class="help" style="margin-top:8px">* Da bismo prikazali relevantne profile, prvo odaberi područje (država + grad).</div>
    </section>

    <!-- REZULTATI -->
    <div id="totalInfo" class="count" style="display:none;margin:8px 0"></div>
    <section id="results" class="results"></section>

    <div class="pagination" id="pager" style="display:none">
      <button id="prevBtn" class="page-btn">« Prethodna</button>
      <div class="page-info" id="pageInfo"></div>
      <button id="nextBtn" class="page-btn">Sljedeća »</button>
    </div>

    <div id="emptyHint" class="card card-pad" style="display:none">Odaberi državu i grad, pa klikni “Prikaži majstore”.</div>
  </main>

  <!-- FOOTER & include loader -->
  <div data-include="footer.html"></div>
  <script src="include.js"></script>

  <!-- DIALOG: 1 vještina -->
  <dialog id="dlgSkill">
    <div class="dlg-head">
      <strong>Odaberi vještinu (1)</strong>
      <button class="btn btn-ghost" onclick="dlgSkill.close()">✕</button>
    </div>
    <div class="dlg-body">
      <input id="skillSearch" placeholder="Pretraži…" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b0d11;color:#fff;margin-bottom:10px">
      <div id="skillList" style="display:grid;gap:8px"></div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" onclick="dlgSkill.close()">Zatvori</button>
    </div>
  </dialog>

  <!-- CONTACT MODAL -->
  <dialog id="contactDlg" class="card" style="border:1px solid var(--fieldBorder);border-radius:16px;padding:0;max-width:560px">
    <form method="dialog" id="contactForm" style="padding:16px" onsubmit="return false;">
      <h3 style="margin:0 0 8px">Pošalji upit majstoru</h3>
      <p id="cProv" class="help" style="margin:0 0 10px"></p>
      <div class="grid">
        <input id="cName" placeholder="Vaše ime *" required>
        <input id="cPhone" placeholder="Vaš telefon *" required>
        <input id="cEmail" type="email" placeholder="Vaš e-mail (opcija)">
        <textarea id="cMsg" placeholder="Kratko opišite posao *" required></textarea>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;justify-content:flex-end">
        <button class="btn btn-ghost" type="button" id="cCancel">Odustani</button>
        <button class="btn btn-primary" type="button" id="cSend">Pošalji</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite">✓ Poslano!</div>

  <script>
  /* ========== UTIL ========== */
  const $ = s => document.querySelector(s);
  const results = $('#results');
  const emptyHint = $('#emptyHint');
  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); };

  function paramsGet(){
    const p = new URLSearchParams(location.search);
    return {
      skill: p.get('skill')||'',
      qlat:  p.get('qlat')?parseFloat(p.get('qlat')):null,
      qlng:  p.get('qlng')?parseFloat(p.get('qlng')):null,
      radius_km: p.get('radius_km')?parseFloat(p.get('radius_km')):25,
      location: p.get('location')||''
    };
  }

  async function apiProviders(filters={}){
    const qs = new URLSearchParams();
    if (filters.skill) qs.set('skill', filters.skill);
    if (filters.location) qs.set('location', filters.location);
    if (Number.isFinite(filters.qlat)) qs.set('qlat', filters.qlat);
    if (Number.isFinite(filters.qlng)) qs.set('qlng', filters.qlng);
    if (Number.isFinite(filters.radius_km)) qs.set('radius_km', filters.radius_km);
    const r = await fetch('api/auth.php?route=providers&'+qs.toString());
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'Greška');
    return j.data || [];
  }
  async function apiProviderDetail(id){
    const r = await fetch('api/auth.php?route=provider&id='+encodeURIComponent(id));
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'Greška');
    return j.data;
  }
  async function apiContact(payload){
    const r = await fetch('api/auth.php?route=contact', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'Greška slanja');
    return j;
  }
  async function track(event, meta={}){
    try{
      await fetch('/api/track.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({event, meta, ts:Date.now()})});
    }catch(_){}
  }

  /* ========== FILTERS: DRŽAVA/GRAD + SKILL ========== */
  const fCountry = $('#fCountry'), fCity = $('#fCity'), fRadius = $('#fRadius');
  const sortBy = $('#sortBy');
  const skillBtn = $('#btnPickSkill'), skillOne = $('#skillOne');
  const dlgSkill = $('#dlgSkill'), skillSearch=$('#skillSearch'), skillList=$('#skillList');
  const btnSearch = $('#btnSearch'), btnClear=$('#btnClear'), locInfo=$('#locInfo');
  const totalInfo = $('#totalInfo');

  const COUNTRY_FILES = {
    "BiH": "/data/cities-bih.json",
    "Hrvatska": "/data/cities-hr.json",
    "Srbija": "/data/cities-rs.json",
    "Slovenija": "/data/cities-si.json",
    "Crna Gora": "/data/cities-mn.json",
    "S. Makedonija": "/data/cities-mk.json"
  };

  function fillCountries(){
    fCountry.innerHTML = '<option value="">— odaberite —</option>'+Object.keys(COUNTRY_FILES).map(c=>`<option>${c}</option>`).join('');
  }
  fCountry.addEventListener('change', async ()=>{
    const c=fCountry.value;
    if(!c){ fCity.innerHTML=''; fCity.disabled=true; updateSearchBtn(); return; }
    fCity.disabled=true; fCity.innerHTML='<option>Učitavam…</option>';
    try{
      const url=COUNTRY_FILES[c];
      const list=await (await fetch(url)).json();
      list.sort((a,b)=> a.name.localeCompare(b.name,'hr'));
      fCity.innerHTML='<option value="">— odaberite —</option>'+list.map(ci=>`<option data-lat="${ci.lat}" data-lng="${ci.lng}">${ci.name}</option>`).join('');
      fCity.disabled=false;
    }catch(_){
      fCity.innerHTML='<option>Greška pri učitavanju</option>';
    }
    updateSearchBtn();
  });
  fCity.addEventListener('change', updateSearchBtn);

  function updateSearchBtn(){
    const ok = !!fCountry.value && !!fCity.value;
    btnSearch.disabled = !ok && !(btnSearch.dataset.qlat && btnSearch.dataset.qlng);
    locInfo.textContent = ok ? (`Područje: ${fCountry.value} / ${fCity.value}`) : (btnSearch.dataset.location || '');
  }

  // Skill picker (1)
  const ALL_SKILLS=[];
  let selectedSkill = '';
  function renderSkillChip(){
    skillOne.innerHTML='';
    if(!selectedSkill) return;
    const chip=document.createElement('span'); chip.className='chip';
    chip.innerHTML=`<span>${selectedSkill}</span> <button title="Ukloni" aria-label="Ukloni">✕</button>`;
    chip.querySelector('button').addEventListener('click', ()=>{ selectedSkill=''; renderSkillChip(); });
    skillOne.appendChild(chip);
  }
  function renderSkillList(filter=''){
    const f=filter.trim().toLowerCase();
    skillList.innerHTML='';
    ALL_SKILLS.filter(s=>!f||s.toLowerCase().includes(f)).forEach(s=>{
      const row=document.createElement('button');
      row.type='button';
      row.className='btn btn-ghost';
      row.style.cssText='text-align:left;justify-content:flex-start';
      row.textContent=s;
      row.addEventListener('click',()=>{ selectedSkill=s; renderSkillChip(); dlgSkill.close(); });
      skillList.appendChild(row);
    });
  }
  skillBtn.addEventListener('click', ()=>{ dlgSkill.showModal(); skillSearch.value=''; renderSkillList(); setTimeout(()=>skillSearch.focus(),50); });
  skillSearch.addEventListener('input', ()=> renderSkillList(skillSearch.value));
  fetch('/data/skills.json').then(r=>r.json()).then(list=>{
    ALL_SKILLS.push(...list.sort((a,b)=>a.localeCompare(b,'hr')));
    renderSkillList();
  }).catch(()=>{});

  // Prefill iz query stringa (ako došli s trazimuslugu.html)
  (function prefillFromQuery(){
    const qp = paramsGet();
    if (qp.skill){ selectedSkill = qp.skill; renderSkillChip(); }
    if (Number.isFinite(qp.radius_km)) fRadius.value = String(qp.radius_km||25);
    if (Number.isFinite(qp.qlat) && Number.isFinite(qp.qlng)){
      btnSearch.disabled = false;
      locInfo.textContent = qp.location ? ('Područje: '+qp.location) : 'Područje: (preuzeto s karte)';
      btnSearch.dataset.qlat = qp.qlat;
      btnSearch.dataset.qlng = qp.qlng;
      btnSearch.dataset.location = qp.location || '';
    }else{
      fillCountries();
      emptyHint.style.display='block';
    }
  })();

  btnClear.addEventListener('click', ()=>{
    selectedSkill=''; renderSkillChip();
    fCountry.value=''; fCity.innerHTML=''; fCity.disabled=true;
    delete btnSearch.dataset.qlat; delete btnSearch.dataset.qlng; delete btnSearch.dataset.location;
    locInfo.textContent=''; updateSearchBtn();
    results.innerHTML=''; emptyHint.style.display='block';
    totalInfo.style.display='none';
    pager.style.display='none';
  });

  /* ========== PRETRAGA / SORT / PAGINACIJA ========== */
  let fullList=[];        // nefiltrirano s API-a (već filtrirano po lokaciji s distance_km)
  let viewList=[];        // sortirani prikaz
  const PAGE_SIZE=10;
  let page=1;

  function applySort(){
    const mode = sortBy.value;
    viewList = [...fullList];
    if (mode==='name'){
      viewList.sort((a,b)=>(a.name||'').localeCompare(b.name||'','hr'));
    } else if (mode==='updated'){
      viewList.sort((a,b)=> new Date(b.updated_at) - new Date(a.updated_at));
    } else {
      // dist default
      viewList.sort((a,b)=>(a.distance_km??9999) - (b.distance_km??9999));
    }
  }

  function pageCount(){ return Math.max(1, Math.ceil(viewList.length / PAGE_SIZE)); }
  function slicePage(){
    const start=(page-1)*PAGE_SIZE, end=start+PAGE_SIZE;
    return viewList.slice(start, end);
  }

  function renderPager(){
    const total=viewList.length;
    const pages=pageCount();
    $('#pager').style.display = total>PAGE_SIZE ? 'flex' : 'none';
    $('#pageInfo').textContent = `Stranica ${page}/${pages}`;
    $('#prevBtn').disabled = page<=1;
    $('#nextBtn').disabled = page>=pages;
    $('#totalInfo').style.display='block';
    $('#totalInfo').textContent = `Pronađeno profila: ${total}`;
  }

  function renderResults(){
    results.innerHTML='';
    const chunk = slicePage();
    chunk.forEach(p=>{
      const el=document.createElement('div');
      el.className='card card-pad';
      const dist = (p.distance_km!=null) ? `<div class="distance">📏 ${p.distance_km} km</div>` : '';
      const skills = (p.skills||[]).slice(0,3).join(', ') || '—';
      const badge = (p.reviews_enabled? `<span class="badge">⭐ Recenzije uključene</span>` : '');
      el.innerHTML = `
        <div class="prov-head">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <div style="font-weight:800;font-size:18px">${p.name || 'Majstor'}</div>
              ${badge}
            </div>
            <div class="muted">🧩 ${skills}</div>
            <div class="muted">📍 ${p.location || '-'}</div>
            ${dist}
          </div>
          <div class="prov-actions">
            <a class="btn btn-ghost" href="provider.html?id=${p.id}">Pregled profila</a>
            <button class="btn btn-primary" data-id="${p.id}" data-name="${p.name||'Majstor'}" data-skills="${skills}">Pošalji upit</button>
            <button class="btn btn-ghost" data-reveal="${p.id}">Prikaži broj</button>
          </div>
        </div>
        <div class="help" style="margin-top:8px">${p.bio ? p.bio : ''}</div>
        <div id="reveal-${p.id}" class="help" style="margin-top:8px"></div>
      `;
      // Pošalji upit
      el.querySelector('button.btn-primary').addEventListener('click', (ev)=>{
        const name = ev.currentTarget.dataset.name;
        const skills = ev.currentTarget.dataset.skills;
        activeProvider = p;
        cProv.textContent = `${name} — ${skills}`;
        cName.value=''; cPhone.value=''; cEmail.value=''; cMsg.value='';
        contactDlg.showModal();
        track('click_contact', {provider_id:p.id});
      });
      // Prikaži broj (lazy detail)
      el.querySelector('[data-reveal]').addEventListener('click', async (ev)=>{
        const pid = parseInt(ev.currentTarget.getAttribute('data-reveal'),10);
        const slot = $('#reveal-'+pid);
        if (slot.dataset.loaded) { slot.scrollIntoView({behavior:'smooth',block:'nearest'}); return; }
        try{
          const d = await apiProviderDetail(pid);
          slot.textContent = d.phone ? ('📞 '+d.phone) : 'Telefon nije dostupan.';
          slot.dataset.loaded = '1';
          track('reveal_phone', {provider_id:pid});
        }catch(e){
          slot.textContent = 'Ne možemo dohvatiti broj.';
        }
      });
      results.appendChild(el);
    });
    renderPager();
  }

  async function runSearch(){
    emptyHint.style.display='none';
    results.innerHTML = '';
    totalInfo.style.display='none';
    $('#pager').style.display='none';

    let qlat, qlng, label='';
    if (btnSearch.dataset.qlat && btnSearch.dataset.qlng){
      qlat = parseFloat(btnSearch.dataset.qlat);
      qlng = parseFloat(btnSearch.dataset.qlng);
      label = btnSearch.dataset.location || '';
    }else{
      const opt=fCity.selectedOptions[0];
      if (!opt){ toast('Odaberite grad.'); return; }
      qlat = parseFloat(opt.dataset.lat);
      qlng = parseFloat(opt.dataset.lng);
      label = `${fCountry.value} / ${fCity.value}`;
    }

    const filters = {
      skill: selectedSkill || '',
      location: label,
      qlat, qlng,
      radius_km: parseFloat(fRadius.value)||25
    };
    try{
      fullList = await apiProviders(filters);
      if (!fullList.length){
        results.innerHTML = '<div class="card card-pad">Nema rezultata za zadane filtere.</div>';
        return;
      }
      page=1;
      applySort();
      renderResults();
    }catch(e){
      results.innerHTML = '<div class="card card-pad">Greška pri pretraživanju.</div>';
    }
  }

  btnSearch.addEventListener('click', runSearch);
  sortBy.addEventListener('change', ()=>{ applySort(); page=1; renderResults(); });

  // pager
  const pager = $('#pager');
  $('#prevBtn').addEventListener('click', ()=>{ if(page>1){ page--; renderResults(); window.scrollTo({top:0,behavior:'smooth'});} });
  $('#nextBtn').addEventListener('click', ()=>{ if(page<pageCount()){ page++; renderResults(); window.scrollTo({top:0,behavior:'smooth'});} });

  /* ========== CONTACT MODAL ========== */
  let activeProvider = null;
  const contactDlg = $('#contactDlg');
  const cProv=$('#cProv'), cName=$('#cName'), cPhone=$('#cPhone'), cEmail=$('#cEmail'), cMsg=$('#cMsg');
  $('#cCancel').addEventListener('click', ()=> contactDlg.close());
  $('#cSend').addEventListener('click', async ()=>{
    if(!activeProvider) return;
    const payload = {
      provider_id: activeProvider.id,
      from_name: cName.value.trim(),
      from_phone: cPhone.value.trim(),
      from_email: cEmail.value.trim(),
      message: cMsg.value.trim()
    };
    if(!payload.from_name || !payload.from_phone || !payload.message){
      alert('Ime, telefon i poruka su obavezni.'); return;
    }
    try{
      await apiContact(payload);
      toast('Upit poslan majstoru. Hvala!');
      contactDlg.close();
      track('send_contact', {provider_id:activeProvider.id});
    }catch(e){
      alert(e.message||'Greška slanja');
    }
  });

  // Ako smo došli s qlat/qlng (iz Tražim uslugu) — odmah pokreni pretragu
  window.addEventListener('DOMContentLoaded', ()=>{
    const qp=paramsGet();
    if (Number.isFinite(qp.qlat) && Number.isFinite(qp.qlng)){
      runSearch();
    }else{
      emptyHint.style.display='block';
    }
  });
  </script>
</body>
</html>
