<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pronađi majstora — Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
  <style>
    :root{
      --bg:#0f1115; --ink:#0b1220; --muted:#c7cbd4;
      --cta:#2563eb; --accent:#16a34a;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --fieldBorder:rgba(255,255,255,.12);
    }
    body{ background:#0f1115; color:#f7f8fa; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    .page{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto; }
    .page-wrap{ max-width:980px; margin:18px auto 64px; padding:0 16px; }

    /* Panel (antracit) – isti kao na nudim/tražim */
    .panel{
      background: linear-gradient(180deg, rgba(26,29,35,.96) 0%, rgba(22,25,31,.96) 100%);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }

    /* Naslovi – identične veličine kao na drugim stranicama */
    .h2{ font-weight:600; font-size:clamp(18px,3vw,26px); margin:0 0 6px; color:#f7f8fa }
    .lead{ color:#c7cbd4; font-size:clamp(13px,2.5vw,16px); margin:0 0 8px }

    /* Cloud (svijetle kartice) – identično */
    .cloud{
      background: linear-gradient(180deg, rgba(255,255,255,.78) 0%, rgba(246,247,249,.72) 100%);
      backdrop-filter: blur(4px);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), 0 8px 22px rgba(0,0,0,.22);
      padding:16px; margin:12px 0; color:var(--ink);
    }
    .cloud h3{ margin:0 0 10px; font-size:18px; color:#0b1220 }

    .row{ display:grid; gap:10px }
    .row.two{ grid-template-columns:1fr 1fr }

    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    /* Bijeli chip kao na nudim/tražim (i u oblaku i izvan njega) */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.6);
      font-weight:600; color:#0b1220;
    }
    .chip button{ all:unset; cursor:pointer; opacity:.85 } .chip button:hover{ opacity:1 }

    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer }
    .btn-primary{
      background:linear-gradient(180deg, #2b6ee9 0%, #245ed0 100%);
      color:#fff; border:1px solid rgba(0,0,0,.2);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.15), 0 6px 16px rgba(37,99,235,.28);
      transition: transform .08s ease;
    }
    .btn-primary:active{ transform: translateY(1px); }
    /* ZELENI gumb (kao na tražim uslugu) */
    .btn-accent{
      background: linear-gradient(180deg, #16a34a 0%, #0f8a3a 55%, #0b6f30 100%);
      color:#e6fff4; border:1px solid rgba(0,0,0,.35);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 6px 16px rgba(16,163,74,.25);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn-accent:hover{ filter:brightness(1.03); box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 8px 20px rgba(16,163,74,.32); }
    .btn-accent:active{ transform: translateY(1px); box-shadow: inset 0 2px 4px rgba(0,0,0,.25), 0 3px 10px rgba(16,163,74,.22); }
    .btn-small{ padding:8px 10px; border-radius:10px }

    .card{ border:1px solid var(--fieldBorder); border-radius:12px; background:rgba(255,255,255,.06) }
    .card-pad{ padding:16px }
    .results{ display:grid; gap:12px }
    @media(min-width:720px){ .results{ grid-template-columns:1fr 1fr } }
    .prov-head{ display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
    .muted{ color:#c7cbd4 }
    .badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--fieldBorder); border-radius:999px; padding:4px 8px; font-size:12px; background:rgba(255,255,255,.06) }

    /* Toast – narančasti */
    .toast{
      position:fixed; left:50%; bottom:25px; transform:translateX(-50%);
      background:#f97316; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
      display:none; z-index:9999;
    }
    .toast.show{ display:block }

    /* Dialogi – identični */
    dialog{ border:0; border-radius:16px; background:#0e1014; color:#f7f8fa; width:min(720px, 96vw) }
    dialog::backdrop{ background:rgba(0,0,0,.4) }
    .dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    .dlg-body{ padding:0; max-height:70vh; overflow:auto; overscroll-behavior:contain }
    .dlg-actions{ padding:14px 16px; display:flex; gap:10px; justify-content:center; border-top:1px solid rgba(255,255,255,.08) }
    .dlg-search{ position:sticky; top:0; z-index:2; background:#0e1014; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }

    #skillSearch{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b0d11; color:#fff }

    /* DlgPlace – svijetli kao drugdje */
    #dlgPlace{
      background: linear-gradient(180deg, rgba(255,255,255,.90) 0%, rgba(246,247,249,.86) 100%);
      color:#0b1220;
    }
    #dlgPlace .dlg-head{ border-bottom:1px solid rgba(0,0,0,.08) }
    #dlgPlace .dlg-actions{ border-top:1px solid rgba(0,0,0,.08) }
    #dlgPlace .field select{
      background:#ffffff; color:#0b1220; border:1px solid rgba(0,0,0,.15);
      border-radius:12px; padding:10px 12px; outline:none; font-family:inherit; font-size:inherit;
    }
    #dlgPlace .field select:focus{ outline:2px solid rgba(37,99,235,.25); border-color:rgba(37,99,235,.45) }

    /* Radijus – tamni popup s gumbima 10→100 km */
    #dlgRadius .dlg-body{ padding:14px 16px }
    .radius-grid{ display:grid; gap:8px; grid-template-columns:repeat(3,1fr) }
    .radius-btn{
      appearance:none; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px;
      background:rgba(255,255,255,.06); color:#f7f8fa; cursor:pointer; text-align:center;
    }
    .radius-btn[aria-current="true"]{ outline:2px solid #16a34a; outline-offset:0 }
  </style>
</head>
<body>
  <main class="page">
    <div data-include="header.html"></div>

    <div class="page-wrap">
      <div class="panel">
        <h2 class="h2">Pronađi majstora</h2>

        <!-- 1) VJEŠTINA (isti popup + zelena tipka) -->
        <section class="cloud" aria-labelledby="lab-skill">
          <h3 id="lab-skill">Vještina</h3>
          <div class="row">
            <div id="skillChip" class="chips" aria-live="polite"></div>
            <div><button id="btnPickSkill" class="btn btn-accent btn-small" type="button">Odaberi vještinu</button></div>
          </div>
        </section>

        <!-- 2) PODRUČJE ILI RADIJUS (međusobno isključivo) -->
        <section class="cloud" aria-labelledby="lab-where">
          <h3 id="lab-where">Područje ili radijus</h3>
          <div class="row two">
            <div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <button id="btnPickPlace" class="btn btn-ghost btn-small" type="button">Odaberi područje</button>
                <div id="placeChip" class="chips" aria-live="polite"></div>
              </div>
            </div>
            <div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <button id="btnPickRadius" class="btn btn-ghost btn-small" type="button">Odaberi radijus</button>
                <div id="radiusChip" class="chips" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- 3) POTRAŽI (plavi) -->
        <div style="display:flex; justify-content:flex-end; margin-top:12px">
          <button id="btnSearch" class="btn btn-primary">Potraži majstora</button>
        </div>

        <!-- REZULTATI -->
        <section id="resultsWrap" style="margin-top:12px">
          <section id="results" class="results"></section>
        </section>
      </div>
    </div>

    <div data-include="footer.html"></div>
  </main>

  <!-- ====== DIALOGI ====== -->

  <!-- Skills – Odustani/X brišu, Spremi sprema (1 vještina) -->
  <dialog id="dlgSkills">
    <div class="dlg-head">
      <strong>Odaberi vještinu (1)</strong>
      <button class="btn btn-ghost btn-small" type="button" id="skillX">✕</button>
    </div>
    <div class="dlg-body">
      <div class="dlg-search"><input id="skillSearch" placeholder="Pretraži ručno.."></div>
      <div id="skillList" class="list" role="listbox" aria-multiselectable="false"></div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" type="button" id="skillCancel">Odustani</button>
      <button class="btn btn-primary" type="button" id="skillSave">Spremi</button>
    </div>
  </dialog>

  <!-- Područje – svijetli popup (država/grad). Odustani/X brišu, Spremi sprema -->
  <dialog id="dlgPlace">
    <div class="dlg-head">
      <strong>Ručni odabir mjesta</strong>
      <button class="btn btn-ghost btn-small" id="btnPlaceX" type="button">✕</button>
    </div>
    <div class="dlg-body" style="padding:14px 16px">
      <div class="row two">
        <div class="field"><label class="help">Država</label><select id="selCountry"></select></div>
        <div class="field"><label class="help">Grad / Mjesto</label><select id="selCity"></select></div>
      </div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" id="btnPlaceCancel" type="button">Odustani</button>
      <button class="btn btn-primary" id="placeSave" type="button">Spremi</button>
    </div>
  </dialog>

  <!-- Radijus – 10→100 km. Odustani/X brišu, Spremi sprema -->
  <dialog id="dlgRadius">
    <div class="dlg-head">
      <strong>Odaberi radijus</strong>
      <button class="btn btn-ghost btn-small" type="button" id="radiusX">✕</button>
    </div>
    <div class="dlg-body" style="padding:14px 16px">
      <div class="radius-grid" id="radiusList"></div>
    </div>
    <div class="dlg-actions">
      <button class="btn btn-ghost" type="button" id="radiusCancel">Odustani</button>
      <button class="btn btn-primary" type="button" id="radiusSave">Spremi</button>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="include.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); clearTimeout(t._hide); t._hide=setTimeout(()=>t.classList.remove('show'),3000); };

    /* ===== API ===== */
    async function apiProviders(filters={}){
      const qs = new URLSearchParams();
      if (filters.skill) qs.set('skill', filters.skill);
      if (filters.location) qs.set('location', filters.location);
      if (Number.isFinite(filters.qlat)) qs.set('qlat', filters.qlat);
      if (Number.isFinite(filters.qlng)) qs.set('qlng', filters.qlng);
      if (Number.isFinite(filters.radius_km)) qs.set('radius_km', filters.radius_km);
      const r = await fetch('api/auth.php?route=providers&'+qs.toString());
      const j = await r.json();
      if(!r.ok) throw new Error(j.error||'Greška');
      return j.data || [];
    }

    /* ===== SKILL popup (1 skill) ===== */
    const ALL_SKILLS=[];
    let selectedSkill='';        // trajno
    let tempSkill='';            // izbor u popupu dok ne klikne Spremi

    const dlgSkills=$('#dlgSkills'), skillSearch=$('#skillSearch'), skillList=$('#skillList'), skillChip=$('#skillChip');

    function renderSkillChip(){
      skillChip.innerHTML='';
      if(!selectedSkill) return;
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span>${selectedSkill}</span> <button title="Ukloni" aria-label="Ukloni">✕</button>`;
      chip.querySelector('button').addEventListener('click', ()=>{ selectedSkill=''; renderSkillChip(); });
      skillChip.appendChild(chip);
    }
    function renderSkillList(filter=''){
      const f=(filter||'').toLowerCase().trim();
      skillList.innerHTML='';
      ALL_SKILLS
        .filter(s=>!f || s.toLowerCase().includes(f))
        .forEach(s=>{
          const row=document.createElement('label'); row.className='item';
          const checked = (tempSkill===s);
          row.innerHTML=`<span>${s}</span><input type="radio" name="skillPick" ${checked?'checked':''}>`;
          row.querySelector('input').addEventListener('change', ()=>{ tempSkill=s; });
          skillList.appendChild(row);
        });
    }
    $('#btnPickSkill').addEventListener('click', ()=>{
      tempSkill = selectedSkill;     // snapshot
      dlgSkills.showModal();
      skillSearch.value='';
      renderSkillList();
      setTimeout(()=>skillSearch.focus(),50);
    });
    $('#skillSave').addEventListener('click', ()=>{ selectedSkill=tempSkill||''; renderSkillChip(); dlgSkills.close(); });
    $('#skillCancel').addEventListener('click', ()=>{ selectedSkill=''; renderSkillChip(); dlgSkills.close(); });
    $('#skillX').addEventListener('click', ()=>{ selectedSkill=''; renderSkillChip(); dlgSkills.close(); });
    dlgSkills.addEventListener('cancel', (e)=>{ e.preventDefault(); selectedSkill=''; renderSkillChip(); dlgSkills.close(); });
    skillSearch.addEventListener('input', ()=> renderSkillList(skillSearch.value));
    fetch('data/skills.json').then(r=>r.json()).then(list=>{
      const arr = Array.isArray(list) ? list : (Array.isArray(list.skills) ? list.skills : []);
      ALL_SKILLS.push(...arr.sort((a,b)=>a.localeCompare(b,'hr')));
      renderSkillList();
    }).catch(()=>{});

    /* ===== PODRUČJE ili RADIJUS – međusobno isključivo ===== */
    const placeChip=$('#placeChip'), radiusChip=$('#radiusChip');
    let chosenPlace=null;     // trajno: {country, city, lat, lng, label}
    let tempPlace=null;       // temp u popupu
    let chosenRadius=null;    // trajno: broj (km)
    let tempRadius=null;      // temp u popupu

    // Područje
    const dlgPlace=$('#dlgPlace'), selCountry=$('#selCountry'), selCity=$('#selCity');
    const COUNTRY_FILES={
      "BiH": "data/cities-bih.json",
      "Hrvatska": "data/cities-hr.json",
      "Srbija": "data/cities-rs.json",
      "Slovenija": "data/cities-si.json",
      "Crna Gora": "data/cities-me.json",
      "S. Makedonija": "data/cities-mk.json"
    };
    function fillCountries(){ selCountry.innerHTML=Object.keys(COUNTRY_FILES).map(c=>`<option>${c}</option>`).join(''); selCountry.dispatchEvent(new Event('change')); }
    selCountry.addEventListener('change', async ()=>{
      selCity.innerHTML='<option>Učitavam…</option>';
      try{
        const url=COUNTRY_FILES[selCountry.value];
        const list=await (await fetch(url,{cache:'no-cache'})).json();
        list.sort((a,b)=> a.name.localeCompare(b.name,'hr'));
        selCity.innerHTML=list.map(ci=>`<option data-lat="${ci.lat}" data-lng="${ci.lng}">${ci.name}</option>`).join('');
      }catch{ selCity.innerHTML='<option>Greška pri učitavanju</option>'; }
    });
    function renderPlaceChip(){
      placeChip.innerHTML='';
      if(!chosenPlace) return;
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span>${chosenPlace.label}</span> <button title="Ukloni" aria-label="Ukloni">✕</button>`;
      chip.querySelector('button').addEventListener('click', ()=>{ chosenPlace=null; renderPlaceChip(); enableRadius(); });
      placeChip.appendChild(chip);
    }
    function disableRadius(){ $('#btnPickRadius').disabled = true; radiusChip.style.opacity=.5; }
    function enableRadius(){ $('#btnPickRadius').disabled = false; radiusChip.style.opacity=1; chosenRadius=null; renderRadiusChip(); }

    $('#btnPickPlace').addEventListener('click', ()=>{
      if (chosenRadius!=null){ toast('Uklonite radijus da biste odabrali područje.'); return; }
      tempPlace = chosenPlace ? {...chosenPlace} : null;
      fillCountries();
      if (tempPlace){
        selCountry.value = tempPlace.country;
        selCountry.dispatchEvent(new Event('change'));
        setTimeout(()=>{
          selCity.value = tempPlace.city;
        },80);
      }
      dlgPlace.showModal();
    });
    $('#placeSave').addEventListener('click', ()=>{
      const opt=selCity.selectedOptions[0]; if(!opt){ toast('Odaberite grad.'); return; }
      const lat=parseFloat(opt.dataset.lat), lng=parseFloat(opt.dataset.lng);
      const label = selCountry.value+' / '+selCity.value;
      chosenPlace = { country:selCountry.value, city:selCity.value, lat, lng, label };
      renderPlaceChip(); disableRadius(); dlgPlace.close();
    });
    const cancelPlace=()=>{ chosenPlace=null; renderPlaceChip(); enableRadius(); dlgPlace.close(); };
    $('#btnPlaceCancel').addEventListener('click', cancelPlace);
    $('#btnPlaceX').addEventListener('click', cancelPlace);
    dlgPlace.addEventListener('cancel', (e)=>{ e.preventDefault(); cancelPlace(); });

    // Radijus
    const dlgRadius=$('#dlgRadius'), radiusList=$('#radiusList');
    function renderRadiusList(){
      radiusList.innerHTML='';
      for(let km=10; km<=100; km+=10){
        const btn=document.createElement('button');
        btn.type='button'; btn.className='radius-btn';
        btn.textContent = km+' km';
        if (tempRadius===km) btn.setAttribute('aria-current','true');
        btn.addEventListener('click', ()=>{
          tempRadius = km;
          [...radiusList.querySelectorAll('.radius-btn')].forEach(b=> b.removeAttribute('aria-current'));
          btn.setAttribute('aria-current','true');
        });
        radiusList.appendChild(btn);
      }
    }
    function renderRadiusChip(){
      radiusChip.innerHTML='';
      if(chosenRadius==null) return;
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span>${chosenRadius} km</span> <button title="Ukloni" aria-label="Ukloni">✕</button>`;
      chip.querySelector('button').addEventListener('click', ()=>{ chosenRadius=null; renderRadiusChip(); enablePlace(); });
      radiusChip.appendChild(chip);
    }
    function disablePlace(){ $('#btnPickPlace').disabled = true; placeChip.style.opacity=.5; }
    function enablePlace(){ $('#btnPickPlace').disabled = false; placeChip.style.opacity=1; chosenPlace=null; renderPlaceChip(); }

    $('#btnPickRadius').addEventListener('click', ()=>{
      if (chosenPlace){ toast('Uklonite područje da biste odabrali radijus.'); return; }
      tempRadius = chosenRadius; renderRadiusList(); dlgRadius.showModal();
    });
    $('#radiusSave').addEventListener('click', ()=>{
      if (typeof tempRadius!=='number'){ toast('Odaberite radijus.'); return; }
      chosenRadius = tempRadius;
      renderRadiusChip(); disablePlace(); dlgRadius.close();
    });
    const cancelRadius=()=>{ chosenRadius=null; renderRadiusChip(); enablePlace(); dlgRadius.close(); };
    $('#radiusCancel').addEventListener('click', cancelRadius);
    $('#radiusX').addEventListener('click', cancelRadius);
    dlgRadius.addEventListener('cancel', (e)=>{ e.preventDefault(); cancelRadius(); });

    /* ===== REZULTATI ===== */
    const results=$('#results');
    let fullList=[], sortMode='dist';
    function applySort(){
      const arr=[...fullList];
      if (sortMode==='name') arr.sort((a,b)=>(a.name||'').localeCompare(b.name||'','hr'));
      else if (sortMode==='updated') arr.sort((a,b)=> new Date(b.updated_at) - new Date(a.updated_at));
      else arr.sort((a,b)=>(a.distance_km??9999)-(b.distance_km??9999));
      return arr;
    }
    function renderResultsList(list){
      results.innerHTML='';
      list.forEach(p=>{
        const el=document.createElement('div');
        el.className='card card-pad';
        const skills=(p.skills||[]).slice(0,3).join(', ')||'—';
        const badge=(p.reviews_enabled? `<span class="badge">⭐ Recenzije uključene</span>`:'');
        const dist=(p.distance_km!=null)? ` · 📏 ${p.distance_km} km`:'';
        el.innerHTML=`
          <div class="prov-head">
            <div>
              <div style="font-weight:800;font-size:18px;display:inline-block;margin-right:8px">${p.name||'Majstor'}</div>
              ${badge}
              <div class="muted">🧩 ${skills}</div>
              <div class="muted">📍 ${p.location||'-'}${dist}</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a class="btn btn-ghost btn-small" href="provider.html?id=${p.id}">Pregled profila</a>
              <button class="btn btn-primary btn-small" data-id="${p.id}">Pošalji upit</button>
            </div>
          </div>`;
        el.querySelector('button[data-id]')?.addEventListener('click', ()=>{
          // Ovdje će backend poslati obavijest majstoru s detaljima iz “Tražim uslugu”.
          // Tipično: POST api/auth.php?route=job_request_forward sa job_id ili payload-om iz sessiona.
          fetch('api/auth.php?route=job_request_forward', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ provider_id:p.id })})
            .then(r=>r.json()).then(()=> toast('Upit poslan majstoru.')).catch(()=> toast('Neuspjelo slanje upita.'));
        });
        results.appendChild(el);
      });
    }

    async function runSearch(){
      const filters={};
      if (selectedSkill) filters.skill=selectedSkill;
      if (chosenPlace){
        filters.location=chosenPlace.label;
        filters.qlat=chosenPlace.lat;
        filters.qlng=chosenPlace.lng;
      } else if (chosenRadius!=null){
        filters.radius_km=chosenRadius;
        // Backend neka koristi zadnju spremljenu privatnu lokaciju korisnika (iz "Tražim uslugu")
      } else {
        toast('Odaberi područje ili radijus.'); return;
      }
      try{
        fullList = await apiProviders(filters);
        renderResultsList(applySort());
        if(!fullList.length) toast('Nema rezultata za zadane filtere.');
      }catch(e){ results.innerHTML='<div class="card card-pad">Greška pri pretraživanju.</div>'; }
    }

    $('#btnSearch').addEventListener('click', runSearch);

    // init
    renderSkillChip(); renderPlaceChip(); renderRadiusChip();
  </script>
</body>
</html>
