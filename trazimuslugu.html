<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra≈æim uslugu ‚Äî Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
</head>
<body>
  <div data-include="header.html"></div>

  <main class="container grid">
    <div class="card" style="padding:16px">
      <h2 style="margin:0 0 8px">Pronaƒëi majstora</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <input id="filterSkill" placeholder="Vje≈°tina (npr. Keramiƒçar)">
        <input id="filterLocation" placeholder="Lokacija (npr. Sarajevo)">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px">
        <select id="radiusKm">
          <option value="">Bez radijusa</option>
          <option value="5">‚Üî do 5 km</option>
          <option value="10">‚Üî do 10 km</option>
          <option value="25">‚Üî do 25 km</option>
          <option value="50">‚Üî do 50 km</option>
          <option value="100">‚Üî do 100 km</option>
        </select>
        <input id="qlat" placeholder="Moja lat (opcija)">
        <input id="qlng" placeholder="Moja lng (opcija)">
      </div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn btn-ghost" type="button" id="btnUseGps">Koristi moju lokaciju</button>
        <button class="btn btn-primary" id="btnSearch">Pretra≈æi</button>
        <button class="btn btn-ghost" id="btnClear">Oƒçisti</button>
      </div>
    </div>

    <section id="results" class="grid"></section>
  </main>

  <!-- Contact modal -->
  <dialog id="contactDlg" class="card" style="border:1px solid var(--fieldBorder);border-radius:16px;padding:0;max-width:560px">
    <form method="dialog" id="contactForm" style="padding:16px" onsubmit="return false;">
      <h3 style="margin:0 0 8px">Po≈°alji upit majstoru</h3>
      <p id="cProv" class="help" style="margin:0 0 10px"></p>
      <div class="grid">
        <input id="cName" placeholder="Va≈°e ime *" required>
        <input id="cPhone" placeholder="Va≈° telefon *" required>
        <input id="cEmail" type="email" placeholder="Va≈° e-mail (opcija)">
        <textarea id="cMsg" placeholder="Kratko opi≈°ite posao *" required></textarea>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;justify-content:flex-end">
        <button class="btn btn-ghost" type="button" id="cCancel">Odustani</button>
        <button class="btn btn-primary" type="button" id="cSend">Po≈°alji</button>
      </div>
    </form>
  </dialog>

  <div data-include="promos.html"></div>
  <div data-include="footer.html"></div>
  <script src="include.js"></script>
  <script src="majstori.js"></script>
  <script>
    const results = document.getElementById('results');
    let lastList = [];
    let activeProvider = null;

    btnUseGps.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Va≈° preglednik ne podr≈æava GPS.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        qlat.value = pos.coords.latitude.toFixed(6);
        qlng.value = pos.coords.longitude.toFixed(6);
      }, err=> alert('GPS gre≈°ka: '+err.message), {enableHighAccuracy:true, timeout:10000});
    });

    async function search(){
      const skill = filterSkill.value.trim();
      const loc   = filterLocation.value.trim();
      const radius = radiusKm.value ? parseFloat(radiusKm.value) : null;
      const qLat  = qlat.value ? parseFloat(qlat.value) : null;
      const qLng  = qlng.value ? parseFloat(qlng.value) : null;

      lastList = await Majstori.fetchProviders({skill, location: loc, qlat: qLat, qlng: qLng, radius_km: radius});
      render();
    }

    function render(){
      results.innerHTML = '';
      if(!lastList.length){
        results.innerHTML = '<div class="card" style="padding:16px">Nema rezultata za zadane filtere.</div>';
        return;
      }
      lastList.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card'; el.style.padding = '16px';
        const dist = (p.distance_km!=null) ? `<div class="help">üìè ${p.distance_km} km</div>` : '';
        el.innerHTML = `
          <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between">
            <div>
              <div style="font-weight:700">${p.name || 'Majstor'}</div>
              <div class="help">${(p.skills||[]).join(', ') || '‚Äî'}</div>
              <div class="help">üìç ${p.location || '‚Äî'}</div>
              ${dist}
            </div>
            <div style="display:flex;gap:10px">
              <a class="btn btn-ghost" href="majstor.html?id=${p.id}">Pregled profila</a>
              <button class="btn btn-primary" data-id="${p.id}">Po≈°alji upit</button>
            </div>
          </div>
          <div class="help" style="margin-top:8px">${p.bio ? p.bio : ''}</div>
        `;
        el.querySelector('button.btn-primary').addEventListener('click', ()=>{
          activeProvider = p;
          cProv.textContent = `${p.name} ‚Äî ${(p.skills||[]).join(', ')}`;
          cName.value=''; cPhone.value=''; cEmail.value=''; cMsg.value='';
          contactDlg.showModal();
        });
        results.appendChild(el);
      });
    }

    btnSearch.addEventListener('click', search);
    btnClear.addEventListener('click', ()=>{ filterSkill.value=''; filterLocation.value=''; radiusKm.value=''; qlat.value=''; qlng.value=''; search(); });
    document.addEventListener('DOMContentLoaded', search);

    cCancel.addEventListener('click', ()=> contactDlg.close());
    cSend.addEventListener('click', async ()=>{
      if(!activeProvider) return;
      const payload = {
        provider_id: activeProvider.id,
        from_name: cName.value.trim(),
        from_phone: cPhone.value.trim(),
        from_email: cEmail.value.trim(),
        message: cMsg.value.trim()
      };
      if(!payload.from_name || !payload.from_phone || !payload.message){
        alert('Ime, telefon i poruka su obavezni.'); return;
      }
      try{
        const r = await fetch('api/auth.php?route=contact', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const j = await r.json(); if(!r.ok) throw new Error(j.error||'Gre≈°ka slanja');
        alert('Upit poslan majstoru. Hvala!');
        contactDlg.close();
      }catch(e){ alert(e.message); }
    });
  </script>
</body>
</html>
