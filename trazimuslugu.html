<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra≈æim uslugu ‚Äî Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
  <style>
    :root{ --bg:#0f1115; --ink:#f7f8fa; --muted:#c7cbd4; --cta:#2563eb; --cta2:#ea580c; --glass:rgba(255,255,255,.08); --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); }
    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    .page{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto; }
    .wrap{ max-width:980px; margin:18px auto 64px; padding:0 16px; }
    .h1{ font-weight:600; font-size:clamp(18px,3vw,26px); margin:10px 0 6px; }
    .lead{ margin:0 0 16px; color:var(--muted); font-size:clamp(13px,2.5vw,16px); }

    .cloud{ background:var(--glass); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius); padding:16px; margin:12px 0 }
    .cloud h3{ margin:0 0 10px; font-size:18px }
    /* Zelena varijanta oblaka */
    .cloud--accent{
      --cloud-bg: rgba(0,160,120,.10);
      --cloud-border: rgba(0,200,160,.35);
      --cloud-shadow: 0 10px 30px rgba(0,200,160,.08);
      background:var(--cloud-bg);
      border-color:var(--cloud-border);
      box-shadow:var(--cloud-shadow);
    }
    .cloud--accent h3{ color:#c7f7eb }

    .note{ margin-top:8px; color:var(--muted); font-size:12px }
    .help{ color:var(--muted) }

    .row{ display:grid; gap:10px }
    .field{ display:grid; gap:6px }
    input[type="text"], input[type="url"], textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:#0e1014; color:var(--ink); outline:none;
    }
    textarea{ min-height:140px; resize:vertical }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); font-weight:600; }
    .chip button{ all:unset; cursor:pointer; opacity:.85 } .chip button:hover{ opacity:1 }

    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer }
    .btn-primary{ background:var(--cta); color:#fff }
    .btn-ghost{ background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.14) }
    .btn-inline{ padding:10px 12px; border-radius:10px }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }

    .subgrid{ display:grid; gap:10px } 
    @media(min-width:700px){ .subgrid-2{ grid-template-columns:1fr 1fr } }

    /* dialog */
    dialog{ border:0; border-radius:16px; background:#0e1014; color:var(--ink); width:min(720px, 96vw) }
    dialog::backdrop{ background:rgba(0,0,0,.4) }
    .dlg-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    .dlg-body{ padding:14px 16px; max-height:70vh; overflow:auto }
    .dlg-actions{ padding:14px 16px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid rgba(255,255,255,.08) }
    .list{ display:grid; gap:8px }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03); }
    .item input{ transform:scale(1.2) }

    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
    .linklike{ color:#9ab; text-decoration:underline; cursor:pointer }
    .muted{ color:var(--muted) }
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#0b7; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); display:none; z-index:60; }
    .toast.show{ display:block }

    /* Uploader */
    .uploader{ margin-top:10px }
    .upload-drop{ border:1px dashed rgba(255,255,255,.25); border-radius:12px; padding:14px; text-align:center; background:rgba(255,255,255,.04); cursor:pointer; }
    .upload-drop:focus{ outline:2px solid rgba(37,99,235,.6) }
    .upload-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:10px; margin-top:10px; }
    .thumb{ position:relative; border-radius:10px; overflow:hidden; background:#0b0d11; border:1px solid rgba(255,255,255,.12); }
    .thumb img{ width:100%; height:90px; object-fit:cover; display:block }
    .thumb button{ position:absolute; top:6px; right:6px; border:0; border-radius:8px; padding:4px 6px; background:rgba(0,0,0,.5); color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <main class="page">
    <div data-include="header.html"></div>

    <div class="wrap">
      <h1 class="h1">Tra≈æite uslugu?</h1>
      <p class="lead">U par klikova ƒáemo vam pomoƒái da pronaƒëete odgovarajuƒáu osobu/majstora.</p>

      <!-- 1) ZANIMANJE -->
      <section class="cloud cloud--accent" aria-labelledby="lab-skill">
        <h3 id="lab-skill">Tko Vam Treba?</h3>
        <div class="row">
          <div class="chips" id="skillChips" aria-live="polite"></div>
          <div>
            <button class="btn btn-ghost btn-inline" type="button" id="btnPickSkills">Odaberi zanimanje</button>
            <span class="muted" id="skillCountInfo">(max 3)</span>
          </div>
        </div>
        <div class="note">* Odaberite zanimanje za koje mislite da ƒáe najbolje odraditi ono ≈°to vam treba.</div>
      </section>

      <!-- 2) OPIS + UPLOAD -->
      <section class="cloud" aria-labelledby="lab-desc">
        <h3 id="lab-desc">≈†to Vam Treba?</h3>
        <div class="field">
          <textarea id="jobDesc" placeholder="U nekoliko reƒçenica opi≈°ite ≈°to toƒçno treba uraditi: opseg posla, va≈æni detalji, rok‚Ä¶"></textarea>
        </div>
        <div class="uploader" id="uploader">
          <input id="fileInput" type="file" accept="image/*" multiple hidden>
          <div class="upload-drop" id="uploadDrop" role="button" tabindex="0">üìé Dodaj fotografije (do 6) ‚Äî povuci i pusti ili klikni ovdje</div>
          <div class="upload-note help">Podr≈æano: JPG, PNG, WEBP. Maks. 5 MB po slici.</div>
          <div class="upload-grid" id="uploadGrid" aria-live="polite"></div>
        </div>
        <div class="note">* Opi≈°ite ≈°to vam toƒçno treba uraditi u nekoliko bitnih detalja. Ova poruka ƒáe stiƒái do kvalificiranih radnika.</div>
      </section>

      <!-- 3) LOKACIJA -->
      <section class="cloud" aria-labelledby="lab-loc">
        <h3 id="lab-loc">Gdje Vam Treba?</h3>
        <div class="subgrid subgrid-2">
          <div class="field">
            <label for="mapsUrl" class="help">Zalijepite link s Google karata (preporuƒçeno)</label>
            <input id="mapsUrl" type="url" placeholder="https://maps.google.com/‚Ä¶">
            <div class="help">
              <span class="linklike" id="openMaps">Otvori Google karte</span>
              ¬∑
              <span class="linklike" id="btnManualPlace" role="button" tabindex="0">Ruƒçni odabir mjesta</span>
            </div>
          </div>
          <div class="field">
            <label class="help">Dodatno poja≈°njenje (ulica, kvart‚Ä¶) ‚Äî opcionalno</label>
            <input id="placeNote" placeholder="npr. kod opƒáine, centar‚Ä¶">
          </div>
        </div>
        <div class="note" style="margin-top:10px">
          * Unesite lokaciju gdje vam treba odraditi uslugu/posao.<br>
          * Va≈°a ƒáe lokacija ovdje ostati <b>uvijek tajna</b> i nitko je neƒáe vidjeti. Koristimo je samo kako bismo najbr≈æe moguƒáe prona≈°li najbli≈æe radnike/majstore koji vam trebaju.<br>
          * Preciznije je koristiti Google karte. Ako ne znate kako, zamolite nekoga da vam pomogne.
        </div>
        <!-- Hidden lat/lng -->
        <input type="hidden" id="lat"><input type="hidden" id="lng"><input type="hidden" id="placeLabel">
      </section>

      <!-- AUTOMATSKI (sustav tra≈æi najbli≈æe) -->
      <section class="cloud cloud--accent" aria-labelledby="lab-auto">
        <h3 id="lab-auto">Zatra≈æi uslugu automatski</h3>
        <p class="help" style="margin:0 0 10px">
          Na≈° sustav automatski pronalazi najbli≈æe majstore koji odgovaraju tra≈æenim zanimanjima.
        </p>
        <div class="actions" style="margin:0">
          <button class="btn btn-primary" id="btnSubmit">Zatra≈æi uslugu</button>
        </div>
      </section>

      <!-- RUƒåNO (ti bira≈° kome ≈°alje≈°) -->
      <section class="cloud cloud--accent" aria-labelledby="lab-manual">
        <h3 id="lab-manual">Zatra≈æi uslugu ruƒçno</h3>
        <p class="help" style="margin:0 0 10px">
          Pregledaj profile i ruƒçno po≈°alji upit onima koje ≈æeli≈° kontaktirati.
        </p>
        <div class="actions" style="margin:0">
          <button class="btn btn-ghost" id="btnBrowse">Zatra≈æi uslugu ruƒçno</button>
        </div>
      </section>

      <div class="note" style="margin-top:12px">
        Nakon slanja, majstori dobivaju obavijest i mogu odgovoriti ‚ÄúZainteresiran sam‚Äù.
        Ako jest ‚Äî dobit ƒáete ime i broj telefona za dogovor.
      </div>
    </div>

    <div data-include="promos.html"></div>
    <div data-include="footer.html"></div>
  </main>

  <!-- DIALOG: Zanimanja -->
  <dialog id="dlgSkills">
    <div class="dlg-head"><strong>Odaberi zanimanja (max 3)</strong><button class="btn btn-ghost btn-inline" onclick="dlgSkills.close()">‚úï</button></div>
    <div class="dlg-body">
      <input id="skillSearch" placeholder="Poƒçetak naziva (npr. 'ele' ‚Üí elektriƒçar)" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b0d11;color:#fff;margin-bottom:10px">
      <div id="skillList" class="list" role="listbox" aria-multiselectable="true"></div>
    </div>
    <div class="dlg-actions"><button class="btn btn-ghost" onclick="dlgSkills.close()">Odustani</button><button class="btn btn-primary" id="skillsSave">Spremi</button></div>
  </dialog>

  <!-- DIALOG: Ruƒçni odabir mjesta -->
  <dialog id="dlgPlace">
    <div class="dlg-head"><strong>Ruƒçni odabir mjesta</strong><button class="btn btn-ghost btn-inline" onclick="dlgPlace.close()">‚úï</button></div>
    <div class="dlg-body">
      <div class="grid-3">
        <div class="field"><label class="help">Dr≈æava (EX-YU)</label><select id="selCountry"></select></div>
        <div class="field"><label class="help">Grad / mjesto (‚â•1k)</label><select id="selCity"></select></div>
        <div class="field"><label class="help">Dodatni opis (ulica, kvart‚Ä¶) ‚Äî opcija</label><input id="placeNote" placeholder="npr. kod opƒáine, centar‚Ä¶"></div>
      </div>
      <div class="note" style="margin-top:8px">Sustav ƒáe uzeti geografski centroid odabranog mjesta za izraƒçun udaljenosti (privatno, nevidljivo).</div>
    </div>
    <div class="dlg-actions"><button class="btn btn-ghost" onclick="dlgPlace.close()">Odustani</button><button class="btn btn-primary" id="placeSave">Spremi lokaciju</button></div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite">‚úì Poslano! Uskoro dobivate odgovore.</div>

  <script src="include.js"></script>
  <script>
    /* ========= UTIL ========= */
    const $ = s => document.querySelector(s);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); };

    /* ========= SKILLS (JSON) ========= */
    const ALL_SKILLS = [];
    fetch('data/skills.json').then(r=>r.json()).then(list=>{
      ALL_SKILLS.push(...list.sort((a,b)=>a.localeCompare(b,'hr')));
      renderSkillList();
    }).catch(()=>{ /* fallback ako JSON nedostupan */ });

    const pickedSkills = new Set();
    const skillChips  = $('#skillChips');
    const dlgSkills   = $('#dlgSkills');
    const skillList   = $('#skillList');
    const skillSearch = $('#skillSearch');

    function renderChips(){
      skillChips.innerHTML='';
      pickedSkills.forEach(s=>{
        const chip=document.createElement('span'); chip.className='chip';
        chip.innerHTML=`<span>${s}</span> <button title="Ukloni" aria-label="Ukloni">‚úï</button>`;
        chip.querySelector('button').addEventListener('click', ()=>{ pickedSkills.delete(s); renderChips(); updateSkillCount(); });
        skillChips.appendChild(chip);
      });
    }
    function updateSkillCount(){ $('#skillCountInfo').textContent=`(odabrano ${pickedSkills.size}/3)`; }

    /* === HR prefiks pretraga (ƒç/ƒá/≈°/≈æ/ƒë) === */
    function stripDiacritics(s){ return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,''); }
    function norm(s){ return stripDiacritics((s||'').toLowerCase().trim()); }
    function startsWithWordPrefix(label, query){
      if(!query) return true;
      const L = norm(label), Q = norm(query);
      if(L.startsWith(Q)) return true;
      return L.split(/\s+/).some(w => w.startsWith(Q));
    }

    function renderSkillList(filter=''){
      skillList.innerHTML='';
      const f = (filter||'');
      ALL_SKILLS
        .filter(s => startsWithWordPrefix(s, f))
        .forEach(s=>{
          const row=document.createElement('label'); row.className='item';
          row.innerHTML=`<span>${s}</span><input type="checkbox" ${pickedSkills.has(s)?'checked':''}>`;
          const cb=row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if(cb.checked){
              if(pickedSkills.size>=3){ cb.checked=false; toast('Mo≈æete odabrati najvi≈°e 3 zanimanja.'); return; }
              pickedSkills.add(s);
            } else {
              pickedSkills.delete(s);
            }
            renderChips(); updateSkillCount();
          });
          skillList.appendChild(row);
        });
    }
    $('#btnPickSkills').addEventListener('click', ()=>{ renderSkillList(); skillSearch.value=''; dlgSkills.showModal(); setTimeout(()=>skillSearch.focus(),50); });
    $('#skillsSave').addEventListener('click', ()=> dlgSkills.close());
    skillSearch.addEventListener('input', ()=> renderSkillList(skillSearch.value));
    /* ESC bri≈°e upit */
    skillSearch.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ skillSearch.value=''; renderSkillList(''); } });

    /* ========= UPLOADER ========= */
    const upload={ files:[], MAX_FILES:6, MAX_MB:5, types:['image/jpeg','image/png','image/webp'] };
    const fileInput=$('#fileInput'), uploadDrop=$('#uploadDrop'), uploadGrid=$('#uploadGrid');
    const bytesToMB=b=>b/(1024*1024);
    function renderThumbs(){
      uploadGrid.innerHTML='';
      upload.files.forEach((it,idx)=>{
        const d=document.createElement('div'); d.className='thumb';
        d.innerHTML=`<img alt="Fotografija #${idx+1}" src="${it.localPreview}"><button type="button" title="Ukloni">‚úï</button>`;
        d.querySelector('button').addEventListener('click',()=>{ upload.files.splice(idx,1); renderThumbs(); });
        uploadGrid.appendChild(d);
      });
    }
    async function addFiles(list){
      for(const f of Array.from(list)){
        if(upload.files.length>=upload.MAX_FILES){ toast('Maksimalno 6 fotografija.'); break; }
        if(!upload.types.includes(f.type)){ toast('Nepodr≈æan format: '+f.type); continue; }
        if(bytesToMB(f.size)>upload.MAX_MB){ toast('Datoteka je prevelika (>5MB): '+f.name); continue; }
        const dataURL = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
        upload.files.push({file:f, localPreview:dataURL, url:null});
      }
      renderThumbs();
    }
    uploadDrop.addEventListener('click', ()=> fileInput.click());
    uploadDrop.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' ') fileInput.click(); });
    fileInput.addEventListener('change', ()=> addFiles(fileInput.files));
    ['dragenter','dragover'].forEach(evt=>{ uploadDrop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); uploadDrop.style.background='rgba(255,255,255,.07)'; }); });
    ['dragleave','drop'].forEach(evt=>{ uploadDrop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); uploadDrop.style.background='rgba(255,255,255,.04)'; }); });
    uploadDrop.addEventListener('drop', e=> addFiles(e.dataTransfer.files));

    async function uploadAllImages(){
      if(upload.files.length===0) return [];
      const fd=new FormData(); upload.files.forEach(it=> fd.append('images[]', it.file, it.file.name));
      const r=await fetch('/api/upload.php',{method:'POST',body:fd}); const j=await r.json();
      if(!r.ok) throw new Error(j.error||'Gre≈°ka pri uploadu slika');
      (j.urls||[]).forEach((url,i)=> upload.files[i].url=url);
      return j.urls||[];
    }

    /* ========= LOKACIJA ========= */
    const mapsUrl=$('#mapsUrl'), latEl=$('#lat'), lngEl=$('#lng'), placeLabel=$('#placeLabel');
    const tryParseGoogleMaps=(url)=>{
      const at=/@(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/.exec(url); if(at) return {lat:parseFloat(at[1]), lng:parseFloat(at[2])};
      const d3d=/!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/.exec(url); if(d3d) return {lat:parseFloat(d3d[1]), lng:parseFloat(d3d[2])};
      return null;
    };
    mapsUrl.addEventListener('change', ()=>{
      const val=mapsUrl.value.trim(); const p=tryParseGoogleMaps(val);
      if(p){ latEl.value=p.lat; lngEl.value=p.lng; placeLabel.value=val; toast('Lokacija prepoznata.'); }
      else{ toast('Nije prepoznata lokacija iz linka. Poku≈°ajte drugi oblik ili ruƒçni odabir.'); }
    });
    $('#openMaps').addEventListener('click', ()=> window.open('https://maps.google.com','_blank'));

    // Ruƒçni odabir ‚Äî lazy load JSON po dr≈æavi
    const dlgPlace=$('#dlgPlace'), selCountry=$('#selCountry'), selCity=$('#selCity'), placeNote=$('#placeNote');
    const COUNTRY_FILES={
      "BiH": "/data/cities-bih.json",
      "Hrvatska": "/data/cities-hr.json",
      "Srbija": "/data/cities-rs.json",
      "Slovenija": "/data/cities-si.json",
      "Crna Gora": "/data/cities-me.json",
      "S. Makedonija": "/data/cities-mk.json"
    };
    function fillCountries(){ selCountry.innerHTML=Object.keys(COUNTRY_FILES).map(c=>`<option>${c}</option>`).join(''); selCountry.dispatchEvent(new Event('change')); }
    selCountry.addEventListener('change', async ()=>{
      const c=selCountry.value, url=COUNTRY_FILES[c]; selCity.innerHTML='<option>Uƒçitavam‚Ä¶</option>';
      try{ const list=await (await fetch(url)).json(); list.sort((a,b)=> a.name.localeCompare(b.name,'hr')); selCity.innerHTML=list.map(ci=>`<option data-lat="${ci.lat}" data-lng="${ci.lng}">${ci.name}</option>`).join(''); }
      catch{ selCity.innerHTML='<option>Gre≈°ka pri uƒçitavanju</option>'; }
    });
    // Linklike "Ruƒçni odabir mjesta"
    $('#btnManualPlace').addEventListener('click', ()=>{ fillCountries(); dlgPlace.showModal(); });
    $('#btnManualPlace').addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); fillCountries(); dlgPlace.showModal(); } });

    $('#placeSave').addEventListener('click', ()=>{
      const opt=selCity.selectedOptions[0]; if(!opt){ toast('Odaberite grad.'); return; }
      latEl.value=parseFloat(opt.dataset.lat); lngEl.value=parseFloat(opt.dataset.lng);
      placeLabel.value=selCountry.value+' / '+selCity.value+(placeNote.value?(' ‚Äî '+placeNote.value):'');
      dlgPlace.close(); toast('Lokacija postavljena.');
    });

    /* ========= SUBMIT (automatsko slanje) ========= */
    function validPayload(){
      if(pickedSkills.size===0){ toast('Odaberite barem jedno zanimanje.'); return false; }
      if(!($('#jobDesc').value||'').trim()){ toast('Napi≈°ite ukratko ≈°to vam treba.'); return false; }
      if(!latEl.value || !lngEl.value){ toast('Postavite lokaciju (Google karte ili ruƒçno).'); return false; }
      return true;
    }
    $('#btnSubmit').addEventListener('click', async ()=>{
      if(!validPayload()) return;
      try{
        const imageUrls=await uploadAllImages();
        const payload={
          skills:Array.from(pickedSkills),
          description:($('#jobDesc').value||'').trim(),
          images:imageUrls,
          location:{ lat:parseFloat(latEl.value), lng:parseFloat(lngEl.value), label:placeLabel.value||'' }
        };
        const r=await fetch('/api/jobs/request.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const j=await r.json(); if(!r.ok) throw new Error(j.error||'Gre≈°ka pri slanju');
        toast('‚úì Poslano! Uskoro dobivate odgovore.'); console.log('JOB_ID', j.id);
      }catch(e){ toast('‚ö† '+(e.message||e)); }
    });

    /* ========= RUƒåNO PREGLEDAVANJE (link na majstori.html) ========= */
    function buildBrowseUrl(){
      const firstSkill = pickedSkills.size ? Array.from(pickedSkills)[0] : '';
      const lat = latEl.value ? parseFloat(latEl.value) : '';
      const lng = lngEl.value ? parseFloat(lngEl.value) : '';
      const label = (placeLabel.value||'').trim();
      const params = new URLSearchParams();
      if (firstSkill) params.set('skill', firstSkill);
      if (lat!=='' && lng!==''){ params.set('qlat', lat); params.set('qlng', lng); params.set('radius_km','25'); }
      if (label) params.set('location', label);
      return 'majstori.html'+(params.toString()?('?'+params.toString()):'');
    }
    $('#btnBrowse').addEventListener('click', ()=>{
      const url = buildBrowseUrl();
      window.location.href = url;
    });

    // init
    renderChips(); updateSkillCount();
  </script>
</body>
</html>
