<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moj profil — Dogovoreno.com</title>
  <link rel="stylesheet" href="base.css">
</head>
<body>
  <!-- Header partial -->
  <div data-include="header.html"></div>

  <main class="container" style="max-width:720px;margin:24px auto">
    <div class="card" style="padding:16px">
      <h2 style="margin:0 0 4px">Moj profil</h2>
      <p class="help" style="margin:0 0 12px">(profil za one koji nude usluge)</p>

      <!-- Tabovi -->
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button id="tabLogin" class="btn btn-ghost" type="button" aria-selected="true">Prijava</button>
        <button id="tabRegister" class="btn btn-ghost" type="button" aria-selected="false">Registracija</button>
      </div>

      <!-- PRIJAVA -->
      <form id="loginForm" class="grid" style="margin:0" onsubmit="return false;">
        <label>Email ili ime ili telefon*
          <input id="lg_identifier" required placeholder="npr. ime@primjer.com ili Marko ili +3876…">
        </label>
        <label>Lozinka*
          <input id="lg_password" type="password" required>
        </label>
        <button id="lg_submit" class="btn btn-primary" type="submit">Prijavi se</button>

        <p class="help" style="margin:14px 0 6px">
          Niste dobili e-mail s potvrdom nakon registracije?
        </p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="resend_email" type="email" placeholder="upišite svoj e-mail" style="max-width:280px">
          <button id="resend_btn" class="btn btn-ghost" type="button">Pošalji ponovo potvrdu</button>
          <span class="help">ili <a href="mailto:podrska@dogovoreno.com">javite nam se</a></span>
        </div>
      </form>

      <!-- REGISTRACIJA -->
      <form id="regForm" class="grid" style="display:none;margin:0" onsubmit="return false;">
        <label>Ime / obrt*
          <input id="rg_name" required>
        </label>
        <label>Telefon*
          <input id="rg_phone" required placeholder="+387 6X XXX XXX">
        </label>
        <label>E-mail*
          <input id="rg_email" type="email" required placeholder="ime@primjer.com">
        </label>
        <label>Lozinka* <span class="help">(min. 8 znakova)</span>
          <input id="rg_password" type="password" required minlength="8">
        </label>
        <button id="rg_submit" class="btn btn-primary" type="submit">Registriraj se</button>
        <p class="help" style="margin:14px 0 0">
          Nakon registracije poslat ćemo vam e-mail za potvrdu.
          Ako poruka ne stigne, provjerite spam ili
          <a href="mailto:podrska@dogovoreno.com">kontaktirajte podršku</a>.
        </p>
      </form>
    </div>
  </main>

  <!-- Footer partial -->
  <div data-include="footer.html"></div>
  <script src="include.js"></script>

  <script>
  (function(){
    const tabLogin   = document.getElementById('tabLogin');
    const tabReg     = document.getElementById('tabRegister');
    const loginForm  = document.getElementById('loginForm');
    const regForm    = document.getElementById('regForm');

    // polja
    const lg_identifier = document.getElementById('lg_identifier');
    const lg_password   = document.getElementById('lg_password');
    const rg_name       = document.getElementById('rg_name');
    const rg_phone      = document.getElementById('rg_phone');
    const rg_email      = document.getElementById('rg_email');
    const rg_password   = document.getElementById('rg_password');

    // resend
    const resendEmail = document.getElementById('resend_email');
    const resendBtn   = document.getElementById('resend_btn');

    // Helper API
    async function api(route, method='GET', body=null){
      const res = await fetch('api/auth.php?route='+route, {
        method, headers:{'Content-Type':'application/json'},
        body: body?JSON.stringify(body):null,
        credentials: 'same-origin'
      });
      let j = {};
      try { j = await res.json(); } catch(_){}
      if(!res.ok) throw new Error(j.error||'Greška');
      return j;
    }

    // Ako je već prijavljen, odmah na uređivanje profila
    (async function checkAuth(){
      try{
        await api('profile','GET');
        location.href = 'nudimuslugu.html';
      }catch(_){ /* not authed → ostani ovdje */ }
    })();

    // UX: ako u identifier upiše e-mail, prebacimo ga i u resend
    lg_identifier?.addEventListener('input', ()=>{
      const v = lg_identifier.value.trim();
      if (v.includes('@') && v.includes('.')) resendEmail.value = v;
    });

    // Tabovi
    function openLogin(){
      tabLogin.setAttribute('aria-selected','true');
      tabReg.setAttribute('aria-selected','false');
      loginForm.style.display='grid';
      regForm.style.display='none';
    }
    function openRegister(){
      tabLogin.setAttribute('aria-selected','false');
      tabReg.setAttribute('aria-selected','true');
      loginForm.style.display='none';
      regForm.style.display='grid';
    }
    tabLogin.addEventListener('click', openLogin);
    tabReg.addEventListener('click', openRegister);

    // Submit: PRIJAVA
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        identifier: (lg_identifier.value||'').trim(),
        password: lg_password.value
      };
      try{
        await api('login','POST', payload);
        location.href = 'nudimuslugu.html';
      }catch(err){
        alert(err.message||'Greška prijave');
      }
    });

    // Submit: REGISTRACIJA
    regForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const body = {
        name: (rg_name.value||'').trim(),
        phone: (rg_phone.value||'').trim(),
        email: (rg_email.value||'').trim().toLowerCase(),
        password: rg_password.value
      };
      try{
        await api('register','POST', body);
        alert('Uspješno! Poslali smo e-mail za potvrdu. Nakon potvrde, prijavite se.');
        openLogin();
        if (!resendEmail.value) resendEmail.value = body.email;
      }catch(err){
        alert(err.message||'Greška registracije');
      }
    });

    // RESEND (route=resend u auth.php)
    resendBtn.addEventListener('click', async ()=>{
      const email = (resendEmail.value || '').trim().toLowerCase();
      if (!email || !email.includes('@')) { alert('Unesite ispravan e-mail.'); return; }
      try{
        await api('resend','POST', { email });
        alert('Ako račun postoji i nije potvrđen, poslali smo novu potvrdu na e-mail.');
      }catch(err){
        // Neutralna poruka (da ne otkrivamo postoji li korisnik)
        alert('Ako račun postoji i nije potvrđen, poslali smo novu potvrdu na e-mail.');
      }
    });
  })();
  </script>
</body>
</html>
